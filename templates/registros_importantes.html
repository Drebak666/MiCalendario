<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registros Importantes</title>
    <!-- Favicon para el icono del acceso directo en móvil -->
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/agenda_icon.png') }}">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" xintegrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Estilos generales para el contenedor principal */
        .container-wrapper {
            max-width: 4xl; /* Equivalente a max-w-4xl */
            margin: auto; /* Equivalente a mx-auto */
            padding: 1rem; /* Equivalente a p-4 */
            background-color: #ffffff; /* bg-white */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            border-radius: 0.5rem; /* rounded-lg */
            margin-top: 1.5rem; /* mt-6 */
        }

        /* Estilos específicos para la página de registros importantes */
        .registro-item {
            background-color: #fff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        @media (min-width: 768px) { /* md: */
            .registro-item {
                flex-direction: row;
                align-items: flex-start;
                justify-content: space-between;
            }
        }
        .registro-header {
            display: flex;
            flex-direction: column; /* Cambiado a columna para móvil */
            justify-content: space-between;
            align-items: flex-start; /* Alineado a la izquierda para móvil */
            flex-wrap: wrap; 
            gap: 10px; 
            width: 100%; /* Ocupa todo el ancho en móvil */
        }
        @media (min-width: 768px) { /* md: */
            .registro-header {
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
            }
        }
        .registro-title {
            font-size: 1.3em;
            color: #333;
            flex-grow: 1; 
            min-width: 150px; 
            font-weight: bold; /* Añadido para hacer el título más prominente */
        }
        .registro-date, .registro-type {
            font-size: 0.9em;
            color: #666;
            background-color: #e9ecef;
            padding: 5px 10px;
            border-radius: 5px;
        }
        .registro-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: flex-end; /* Alineado a la derecha */
            width: 100%; /* Ocupa todo el ancho en móvil */
            margin-top: 10px; /* Espacio para móvil */
        }
        @media (min-width: 768px) { /* md: */
            .registro-actions {
                width: auto;
                margin-top: 0;
            }
        }
        .registro-description {
            font-size: 1em;
            color: #555;
            margin-top: 5px;
            line-height: 1.5;
            white-space: pre-wrap; 
            width: 100%; /* Ocupa todo el ancho */
        }
        .registro-image-container {
            margin-top: 10px;
            text-align: center;
            width: 100%; /* Ocupa todo el ancho en móvil */
        }
        @media (min-width: 768px) { /* md: */
            .registro-image-container {
                max-width: 150px; /* Más pequeño en escritorio */
                flex-shrink: 0; /* No se encoge */
            }
        }
        .registro-image {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            object-fit: cover; /* Asegura que la imagen se ajuste bien */
        }
        .month-header {
            font-size: 1.5rem; /* text-2xl */
            font-weight: bold;
            color: #4a5568; /* gray-700 */
            margin-top: 2rem; /* mt-8 */
            margin-bottom: 0.75rem; /* mb-3 */
            border-bottom: 1px solid #e2e8f0; /* border-b */
            padding-bottom: 0.5rem; /* pb-2 */
        }
        .month-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .month-navigation button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease-in-out;
        }
        .month-navigation button:hover {
            background-color: #0056b3;
        }
        .current-month-year {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }
        .add-registro-container {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .add-registro-container label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        .add-registro-container input[type="text"],
        .add-registro-container input[type="date"],
        .add-registro-container textarea,
        .add-registro-container select {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 1em;
        }
        .add-registro-container button.boton {
            width: auto;
            padding: 10px 20px;
            margin-right: 10px;
        }
        .file-upload-section, .photo-capture-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #eee;
        }
        .file-upload-section input[type="file"] {
            margin-top: 5px;
            margin-bottom: 10px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: auto;
        }
        .file-preview-container {
            margin-top: 10px;
            text-align: center;
        }
        .file-preview-container img, .file-preview-container video {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .file-preview-container p {
            font-style: italic;
            color: #777;
        }

        /* Estilos de la cámara */
        .camera-modal-content {
            max-width: 700px;
        }
        .camera-stream {
            width: 100%;
            max-width: 100%;
            height: auto;
            background-color: #000;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .photo-preview {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .camera-actions button {
            margin: 5px;
        }

        /* Estilos para el modal de login */
        #loginModal {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        #loginModal .custom-modal-content {
            background-color: #fff;
            padding: 24px; /* p-6 */
            border-radius: 8px; /* rounded-lg */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); /* shadow-xl */
            max-width: 400px;
            text-align: center;
            width: 90%; /* Ajuste para móvil */
        }
        #loginModal input[type="password"] {
            padding: 10px;
            margin: 15px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: calc(100% - 20px);
            box-sizing: border-box;
            font-size: 1.2em;
            text-align: center;
        }
        #loginModal button {
            width: 100%;
            padding: 12px 0;
            font-size: 1.1em;
            background-color: #007bff; /* blue-500 */
            color: white;
            font-weight: bold;
            border-radius: 9999px; /* rounded-full */
            transition: background-color 0.2s;
        }
        #loginModal button:hover {
            background-color: #0056b3; /* blue-700 */
        }
        #loginError {
            color: #dc3545; /* red-500 */
            margin-top: 10px;
        }

        /* Estilos para el modal genérico (alert/confirm) */
        .custom-modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000; /* Asegura que esté por encima de otros elementos */
        }
        .custom-modal-content {
            background-color: #fff;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .custom-modal-content h3 {
            font-size: 1.25rem; /* text-xl */
            font-weight: bold;
            margin-bottom: 1rem; /* mb-4 */
            color: #1a202c; /* gray-900 */
        }
        .custom-modal-content p {
            margin-bottom: 1.5rem; /* mb-6 */
            color: #4a5568; /* gray-700 */
        }
        .modal-actions {
            display: flex;
            justify-content: center;
            gap: 1rem; /* space-x-4 */
        }
        .modal-actions .boton {
            padding: 0.5rem 1rem; /* py-2 px-4 */
            font-weight: bold;
            border-radius: 9999px; /* rounded-full */
            transition: all 0.2s ease-in-out;
            background-color: #4299e1; /* blue-500 */
            color: white;
        }
        .modal-actions .boton:hover {
            background-color: #2b6cb0; /* blue-700 */
        }
        .modal-actions .cancel-button {
            background-color: #a0aec0; /* gray-500 */
        }
        .modal-actions .cancel-button:hover {
            background-color: #718096; /* gray-700 */
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">
    <!-- Modal de Login (Inicialmente visible) -->
    <div id="loginModal">
        <div class="custom-modal-content">
            <h3 class="text-xl font-bold mb-4">Acceso a Registros Importantes</h3>
            <p class="mb-4 text-gray-700">Por favor, introduce el PIN para acceder.</p>
            <input type="password" id="pinInput" placeholder="Introduce tu PIN" maxlength="4" class="block w-full p-3 mb-4 border border-gray-300 rounded-md text-center text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button id="loginButton" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-full w-full">Acceder</button>
            <p id="loginError" class="text-red-500 mt-2 text-sm"></p>
        </div>
    </div>

    <div class="container-wrapper" id="mainContent" style="display:none;">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Tus Registros Importantes</h1>

        <!-- Formulario para Añadir Nuevo Registro -->
        <div class="add-registro-container">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Añadir Nuevo Registro</h2>
            <form id="addRegistroForm">
                <div class="mb-4">
                    <label for="registroAddFecha" class="block text-gray-700 text-sm font-bold mb-2">Fecha:</label>
                    <input type="date" id="registroAddFecha" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="mb-4">
                    <label for="registroAddTitulo" class="block text-gray-700 text-sm font-bold mb-2">Título:</label>
                    <input type="text" id="registroAddTitulo" placeholder="Título del registro" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="mb-4">
                    <label for="registroAddDescripcion" class="block text-gray-700 text-sm font-bold mb-2">Descripción:</label>
                    <textarea id="registroAddDescripcion" rows="5" placeholder="Contenido o descripción del registro" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
                </div>
                <div class="mb-4">
                    <label for="registroAddTipo" class="block text-gray-700 text-sm font-bold mb-2">Tipo:</label>
                    <select id="registroAddTipo" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <!-- Opciones cargadas dinámicamente -->
                    </select>
                </div>
                
                <div class="photo-capture-section flex flex-col items-center border-t border-dashed border-gray-300 pt-4 mt-4">
                    <p class="text-gray-700 text-sm font-bold mb-3">Opcional: Adjuntar una foto o archivo</p>
                    <div class="flex flex-col md:flex-row gap-3 items-center w-full justify-center">
                        <button type="button" id="openCameraAddButton" class="boton bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full flex items-center space-x-2">
                            <i class="fas fa-camera"></i> <span>Tomar Foto</span>
                        </button>
                        <input type="file" id="fileUploadInput" accept="image/*, .txt, .pdf, .doc, .docx" class="block text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 cursor-pointer focus:outline-none file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    </div>
                    <div id="filePreviewContainer" class="file-preview-container mt-4 p-3 border border-gray-200 rounded-lg bg-gray-50" style="display:none;">
                        <img id="fileImagePreview" class="registro-image" style="display:none;">
                        <p id="fileTextPreview" class="text-sm text-gray-600" style="display:none;"></p>
                    </div>
                    <button type="button" id="clearFileButton" class="boton cancel-button bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full mt-4 flex items-center space-x-2" style="display:none;">
                        <i class="fas fa-times"></i> <span>Limpiar Archivo/Foto</span>
                    </button>
                </div>

                <button type="submit" class="boton bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:shadow-lg w-full mt-6">
                    <i class="fas fa-save"></i> Guardar Registro
                </button>
            </form>
        </div>

        <!-- Filtros y Navegación de Registros -->
        <div class="month-navigation mt-8">
            <button id="prevMonth" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full flex items-center space-x-2">
                <i class="fas fa-chevron-left"></i> <span>Mes Anterior</span>
            </button>
            <span id="currentMonthYear" class="current-month-year text-lg"></span>
            <button id="nextMonth" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full flex items-center space-x-2">
                <span>Mes Siguiente</span> <i class="fas fa-chevron-right"></i>
            </button>
        </div>

        <div class="mb-4 mt-4">
            <label for="filterTipo" class="block text-gray-700 text-sm font-bold mb-2">Filtrar por Categoría:</label>
            <select id="filterTipo" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                <option value="">Todas las categorías</option>
                <!-- Opciones cargadas dinámicamente -->
            </select>
        </div>

        <ul id="registrosList" class="notes-list space-y-4">
            <li class="text-gray-500 italic">Cargando registros...</li>
        </ul>

        <div class="navigation grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-3 p-2 mt-8">
            <a href="/" class="boton flex flex-col items-center justify-center p-3 rounded-lg shadow hover:shadow-lg transition-shadow bg-blue-400 text-white">
                <i class="fas fa-home text-2xl mb-1"></i>
                <span>Inicio</span>
            </a>
            <a href="/calendario" class="boton flex flex-col items-center justify-center p-3 rounded-lg shadow hover:shadow-lg transition-shadow bg-blue-400 text-white">
                <i class="fas fa-calendar-alt text-2xl mb-1"></i>
                <span>Calendario</span>
            </a>
            <a href="/alimentacion" class="boton flex flex-col items-center justify-center p-3 rounded-lg shadow hover:shadow-lg transition-shadow bg-yellow-400 text-white">
                <i class="fas fa-utensils text-2xl mb-1"></i>
                <span>Alimentación</span>
            </a>
            <a href="/documentacion" class="boton flex flex-col items-center justify-center p-3 rounded-lg shadow hover:shadow-lg transition-shadow bg-pink-400 text-white">
                <i class="fas fa-folder-open text-2xl mb-1"></i>
                <span>Documentos</span>
            </a>
            <a href="/gimnasio" class="boton flex flex-col items-center justify-center p-3 rounded-lg shadow hover:shadow-lg transition-shadow bg-red-400 text-white">
                <i class="fas fa-dumbbell text-2xl mb-1"></i>
                <span>Gimnasio</span>
            </a>
            <a href="/citas" class="relative boton flex flex-col items-center justify-center p-3 rounded-lg shadow hover:shadow-lg transition-shadow bg-teal-400 text-white">
                <i class="fas fa-calendar-check text-2xl mb-1"></i>
                <span>Citas</span>
            </a>
            <a href="/lista" class="relative boton flex flex-col items-center justify-center p-3 rounded-lg shadow hover:shadow-lg transition-shadow bg-orange-400 text-white">
                <i class="fas fa-shopping-cart text-2xl mb-1"></i>
                <span>Lista Compra</span>
            </a>
            <a href="/notas" class="relative boton flex flex-col items-center justify-center p-3 rounded-lg shadow hover:shadow-lg transition-shadow bg-indigo-400 text-white">
                <i class="fas fa-pencil-alt text-2xl mb-1"></i>
                <span>Notas</span>
            </a>
        </div>
    </div>

    <!-- Modal para Captura de Foto (REUTILIZADO DEL INDEX) -->
    <div id="cameraModal" class="custom-modal-overlay" style="display:none;">
        <div class="custom-modal-content camera-modal-content">
            <h3 class="text-xl font-bold mb-4 text-center">Tomar Foto</h3>
            <video id="videoStream" class="camera-stream" autoplay playsinline></video>
            <canvas id="photoCanvas" style="display:none;"></canvas>
            <img id="photoPreview" class="photo-preview" style="display:none;">
            <p id="cameraStatus" class="text-center text-gray-600 text-sm mb-4"></p>
            <div class="camera-actions flex justify-center flex-wrap gap-2">
                <button id="capturePhotoButton" class="boton bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full flex items-center space-x-2">
                    <i class="fas fa-camera"></i> <span>Tomar Foto</span>
                </button>
                <button id="retakePhotoButton" class="boton cancel-button bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full flex items-center space-x-2" style="display:none;">
                    <i class="fas fa-redo"></i> <span>Repetir</span>
                </button>
                <button id="confirmPhotoButton" class="boton bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full flex items-center space-x-2" style="display:none;">
                    <i class="fas fa-check"></i> <span>Confirmar</span>
                </button>
                <button id="closeCameraModalButton" class="boton cancel-button bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full flex items-center space-x-2">
                    <i class="fas fa-times"></i> <span>Cerrar</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Alert/Confirm Modal HTML (GLOBAL) -->
    <div id="customModalOverlay" class="custom-modal-overlay" style="display:none;">
        <div class="custom-modal-content">
            <h3 id="customModalTitle" class="text-xl font-bold mb-4 text-center"></h3>
            <p id="customModalMessage" class="mb-6 text-gray-700 text-center"></p>
            <div class="modal-actions flex justify-center space-x-4" id="customModalActions">
                <!-- Buttons will be injected here -->
            </div>
        </div>
    </div>

    <script>
        const loginModal = document.getElementById('loginModal');
        const pinInput = document.getElementById('pinInput');
        const loginButton = document.getElementById('loginButton');
        const loginError = document.getElementById('loginError');
        const mainContent = document.getElementById('mainContent');

        const addRegistroForm = document.getElementById('addRegistroForm');
        const registroAddFecha = document.getElementById('registroAddFecha');
        const registroAddTitulo = document.getElementById('registroAddTitulo');
        const registroAddDescripcion = document.getElementById('registroAddDescripcion');
        const registroAddTipo = document.getElementById('registroAddTipo');

        const fileUploadInput = document.getElementById('fileUploadInput');
        const filePreviewContainer = document.getElementById('filePreviewContainer');
        const fileImagePreview = document.getElementById('fileImagePreview');
        const fileTextPreview = document.getElementById('fileTextPreview');
        const clearFileButton = document.getElementById('clearFileButton');
        const openCameraAddButton = document.getElementById('openCameraAddButton');


        const registrosList = document.getElementById('registrosList');
        const prevMonthButton = document.getElementById('prevMonth');
        const nextMonthButton = document.getElementById('nextMonth');
        const currentMonthYearSpan = document.getElementById('currentMonthYear');
        const filterTipoSelect = document.getElementById('filterTipo');

        let currentDisplayDate = new Date(); // Usado para la navegación por meses/años
        let allRegistros = []; // Cache para todos los registros para filtrado
        let currentFileBase64 = null;
        let currentFileName = null;
        let currentMimeType = null;

        // Elementos de la Cámara
        const cameraModal = document.getElementById('cameraModal');
        const videoStream = document.getElementById('videoStream');
        const photoCanvas = document.getElementById('photoCanvas');
        const photoPreview = document.getElementById('photoPreview');
        const capturePhotoButton = document.getElementById('capturePhotoButton');
        const retakePhotoButton = document.getElementById('retakePhotoButton');
        const confirmPhotoButton = document.getElementById('confirmPhotoButton');
        const closeCameraModalButton = document.getElementById('closeCameraModalButton');
        const cameraStatus = document.getElementById('cameraStatus');

        let currentStream;

        // --- Funciones de Modal Personalizado (copiado de index.html) ---
        function showCustomModal(message, title = 'Mensaje', type = 'alert') {
            return new Promise((resolve) => {
                const modalOverlay = document.getElementById('customModalOverlay');
                const modalTitle = document.getElementById('customModalTitle');
                const modalMessage = document.getElementById('customModalMessage');
                const modalActions = document.getElementById('customModalActions');

                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalActions.innerHTML = ''; // Limpiar botones anteriores

                if (type === 'alert') {
                    const okButton = document.createElement('button');
                    okButton.classList.add('bg-blue-500', 'hover:bg-blue-700', 'text-white', 'font-bold', 'py-2', 'px-4', 'rounded-full');
                    okButton.textContent = 'Aceptar';
                    okButton.addEventListener('click', () => {
                        modalOverlay.style.display = 'none';
                        resolve(true);
                    });
                    modalActions.appendChild(okButton);
                } else if (type === 'confirm') {
                    const yesButton = document.createElement('button');
                    yesButton.classList.add('bg-green-500', 'hover:bg-green-700', 'text-white', 'font-bold', 'py-2', 'px-4', 'rounded-full');
                    yesButton.textContent = 'Sí';
                    yesButton.addEventListener('click', () => {
                        modalOverlay.style.display = 'none';
                        resolve(true);
                    });
                    const noButton = document.createElement('button');
                    noButton.classList.add('bg-gray-500', 'hover:bg-gray-700', 'text-white', 'font-bold', 'py-2', 'px-4', 'rounded-full');
                    noButton.textContent = 'No';
                    noButton.addEventListener('click', () => {
                        modalOverlay.style.display = 'none';
                        resolve(false);
                    });
                    modalActions.appendChild(yesButton);
                    modalActions.appendChild(noButton);
                }

                modalOverlay.style.display = 'flex';
            });
        }

        function showCustomAlert(message, title = 'Mensaje') {
            return showCustomModal(message, title, 'alert');
        }

        async function showCustomConfirm(message, title = 'Confirmación') {
            return await showCustomModal(message, title, 'confirm');
        }

        // --- Lógica de Autenticación (PIN) ---
        loginButton.addEventListener('click', async () => {
            const pin = pinInput.value;
            const response = await fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pin: pin })
            });
            const data = await response.json();
            if (response.ok) {
                loginModal.style.display = 'none';
                mainContent.style.display = 'block';
                await fetchAndRenderAllData(); // Cargar todos los datos una vez logueado
            } else {
                loginError.textContent = data.error;
            }
        });

        pinInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loginButton.click();
            }
        });

        // --- Lógica de la Cámara (adaptada para registros_importantes) ---
        async function initCamera() {
            cameraStatus.textContent = 'Iniciando cámara...';
            videoStream.style.display = 'block';
            photoPreview.style.display = 'none';
            capturePhotoButton.style.display = 'block'; 
            retakePhotoButton.style.display = 'none';
            confirmPhotoButton.style.display = 'none';
            clearFilePreview(); // Limpiar previsualización de archivo antes de cámara

            if (currentStream) {
                stopCamera();
            }

            try {
                currentStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: { exact: 'environment' } // Preferir cámara trasera
                    }
                });
                videoStream.srcObject = currentStream;
                videoStream.play();
                cameraStatus.textContent = 'Cámara trasera activa. Haz clic en "Tomar Foto".';
            } catch (err) {
                console.warn("ADVERTENCIA: No se pudo acceder a la cámara trasera, intentando la frontal:", err);
                cameraStatus.textContent = 'Cámara trasera no disponible, intentando la frontal.';
                try {
                    currentStream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'user'
                        }
                    });
                    videoStream.srcObject = currentStream;
                    videoStream.play();
                    cameraStatus.textContent = 'Cámara frontal activa. Haz clic en "Tomar Foto".';
                } catch (errFront) {
                    console.error("ERROR: No se pudo acceder a ninguna cámara: ", errFront);
                    showCustomAlert('No se pudo acceder a la cámara. Asegúrate de haber dado permiso y de que no esté en uso por otra aplicación.', 'Error de Cámara');
                    cameraModal.style.display = 'none';
                    cameraStatus.textContent = 'No se pudo acceder a ninguna cámara. Verifica permisos.';
                    return;
                }
            }
        }

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                videoStream.srcObject = null;
            }
        }

        capturePhotoButton.addEventListener('click', () => {
            if (videoStream.readyState === videoStream.HAVE_ENOUGH_DATA) {
                photoCanvas.width = videoStream.videoWidth;
                photoCanvas.height = videoStream.videoHeight;
                const context = photoCanvas.getContext('2d');
                context.drawImage(videoStream, 0, 0, photoCanvas.width, photoCanvas.height);
                
                currentFileBase64 = photoCanvas.toDataURL('image/png');
                currentFileName = `foto_registro_${new Date().toISOString().substring(0,10)}.png`;
                currentMimeType = 'image/png';

                photoPreview.src = currentFileBase64;
                videoStream.style.display = 'none';
                photoPreview.style.display = 'block';
                capturePhotoButton.style.display = 'none';
                retakePhotoButton.style.display = 'block';
                confirmPhotoButton.style.display = 'block';
                cameraStatus.textContent = 'Foto capturada. Confirma o repite.';
                stopCamera();
            } else {
                cameraStatus.textContent = 'Esperando stream de video para capturar...';
            }
        });

        retakePhotoButton.addEventListener('click', () => {
            currentFileBase64 = null;
            currentFileName = null;
            currentMimeType = null;
            photoPreview.style.display = 'none';
            capturePhotoButton.style.display = 'block'; 
            retakePhotoButton.style.display = 'none';
            confirmPhotoButton.style.display = 'none';
            initCamera();
        });

        confirmPhotoButton.addEventListener('click', () => {
            cameraModal.style.display = 'none';
            stopCamera();
            updateFilePreview(); // Mostrar la foto capturada en el formulario de añadir/editar
            cameraStatus.textContent = '';
            capturePhotoButton.style.display = 'block';
            retakePhotoButton.style.display = 'none';
            confirmPhotoButton.style.display = 'none';
        });

        closeCameraModalButton.addEventListener('click', () => {
            cameraModal.style.display = 'none';
            stopCamera();
            currentFileBase64 = null;
            currentFileName = null;
            currentMimeType = null;
            clearFilePreview(); // Limpiar si se cierra sin confirmar
            cameraStatus.textContent = '';
            capturePhotoButton.style.display = 'block';
            retakePhotoButton.style.display = 'none';
            confirmPhotoButton.style.display = 'none';
        });

        openCameraAddButton.addEventListener('click', () => {
            cameraModal.style.display = 'flex';
            videoStream.style.display = 'block';
            photoPreview.style.display = 'none';
            capturePhotoButton.style.display = 'block'; 
            retakePhotoButton.style.display = 'none';
            confirmPhotoButton.style.display = 'none';
            initCamera();
        });

        // --- Lógica de Subida de Archivos ---
        fileUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentFileBase64 = e.target.result;
                    currentFileName = file.name;
                    currentMimeType = file.type;
                    updateFilePreview();
                };
                reader.readAsDataURL(file);
            } else {
                currentFileBase64 = null;
                currentFileName = null;
                currentMimeType = null;
                clearFilePreview();
            }
        });

        clearFileButton.addEventListener('click', () => {
            currentFileBase64 = null;
            currentFileName = null;
            currentMimeType = null;
            fileUploadInput.value = ''; // Reset file input
            clearFilePreview();
        });

        function updateFilePreview() {
            filePreviewContainer.style.display = 'block';
            clearFilePreviewContent(); // Limpiar cualquier previsualización anterior

            if (currentFileBase64 && currentMimeType) {
                clearFileButton.style.display = 'block'; // Mostrar botón de limpiar

                if (currentMimeType.startsWith('image/')) {
                    fileImagePreview.src = currentFileBase64;
                    fileImagePreview.style.display = 'block';
                } else if (currentMimeType.startsWith('text/')) {
                    // Para archivos de texto, mostrar un snippet o un icono
                    fileTextPreview.textContent = `Archivo de texto: ${currentFileName || 'Sin Nombre'}`;
                    fileTextPreview.style.display = 'block';
                } else {
                    fileTextPreview.textContent = `Archivo adjunto: ${currentFileName || 'Sin Nombre'} (${currentMimeType})`;
                    fileTextPreview.style.display = 'block';
                }
            } else {
                filePreviewContainer.style.display = 'none';
                clearFileButton.style.display = 'none';
            }
        }

        function clearFilePreview() {
            filePreviewContainer.style.display = 'none';
            clearFilePreviewContent();
            clearFileButton.style.display = 'none';
            fileUploadInput.value = ''; // Reset file input
        }

        function clearFilePreviewContent() {
            fileImagePreview.style.display = 'none';
            fileImagePreview.src = '';
            fileTextPreview.style.display = 'none';
            fileTextPreview.textContent = '';
        }


        // --- Lógica de Filtros y Navegación de Registros ---
        function updateMonthYearDisplay() {
            const options = { year: 'numeric', month: 'long' };
            currentMonthYearSpan.textContent = currentDisplayDate.toLocaleDateString('es-ES', options).
                                                replace(/\b\w/g, char => char.toUpperCase()); // Capitalize words
        }

        async function fetchTiposRegistro() {
            try {
                // Fetch tipos_registro sin requerir login inicialmente
                const response = await fetch('/api/tipos_registro'); 
                if (!response.ok) {
                    // Si el login no ha ocurrido, se espera un 401.
                    // Si el usuario no está logueado, esta llamada fallará hasta que lo esté.
                    if (response.status === 401) {
                         console.warn("No autenticado para cargar tipos de registro. Se cargará después del login.");
                         return; // Sale sin mostrar error al usuario
                    }
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error al cargar los tipos de registro.');
                }
                const tipos = await response.json();
                
                // Rellenar select de añadir registro
                registroAddTipo.innerHTML = '';
                tipos.forEach(tipo => {
                    const option = document.createElement('option');
                    option.value = tipo.nombre;
                    option.textContent = tipo.nombre;
                    registroAddTipo.appendChild(option);
                });

                // Rellenar select de filtro
                filterTipoSelect.innerHTML = '<option value="">Todas las categorías</option>';
                tipos.forEach(tipo => {
                    const option = document.createElement('option');
                    option.value = tipo.nombre;
                    option.textContent = tipo.nombre;
                    filterTipoSelect.appendChild(option);
                });

            } catch (error) {
                console.error('Error al cargar tipos de registro:', error);
                showCustomAlert(`No se pudieron cargar las categorías de registro: ${error.message}`, 'Error de Categorías');
            }
        }

        async function fetchAndRenderAllData() {
            registrosList.innerHTML = '<li class="text-gray-500 italic">Cargando registros...</li>';
            try {
                const response = await fetch('/api/registros_importantes');
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error al cargar los registros importantes.');
                }
                allRegistros = await response.json(); // Guarda todos los registros
                
                // Sort all records once by date ascending for correct monthly grouping
                allRegistros.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

                renderRegistros(); // Llama a render sin argumentos para usar el caché
                await fetchTiposRegistro(); // Cargar tipos después del login
            } catch (error) {
                console.error('Error al cargar registros:', error);
                registrosList.innerHTML = `<li class="mensaje-info" style="color: #dc3545;">Error: ${error.message}. No se pudieron cargar los registros.</li>`;
                showCustomAlert(`No se pudieron cargar los registros: ${error.message}`, 'Error de Carga');
            }
        }

        function renderRegistros() {
            registrosList.innerHTML = '';
            
            const selectedCategory = filterTipoSelect.value;
            let currentMonthYear = ''; // To track the current month and year for grouping

            const filteredRegistros = allRegistros.filter(registro => {
                const registroDate = new Date(registro.fecha);
                const matchesMonth = registroDate.getFullYear() === currentDisplayDate.getFullYear() &&
                                     registroDate.getMonth() === currentDisplayDate.getMonth();
                const matchesCategory = !selectedCategory || registro.tipo === selectedCategory;
                return matchesMonth && matchesCategory;
            });

            if (filteredRegistros.length === 0) {
                registrosList.innerHTML = '<li class="text-gray-500 italic">No hay registros importantes para este mes y categoría.</li>';
                return;
            }

            filteredRegistros.forEach(registro => {
                const registroDateObj = new Date(registro.fecha);
                const monthYear = `${registroDateObj.getFullYear()}-${String(registroDateObj.getMonth() + 1).padStart(2, '0')}`;

                // If the month/year changes for the *filtered* records, add a new header
                if (monthYear !== currentMonthYear) {
                    currentMonthYear = monthYear;
                    const monthHeader = document.createElement('h3');
                    monthHeader.classList.add('month-header'); 
                    const monthName = registroDateObj.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                    monthHeader.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1); 
                    registrosList.appendChild(monthHeader);
                }

                const li = document.createElement('li');
                li.classList.add('registro-item', 'bg-white', 'p-4', 'rounded-lg', 'shadow-md', 'flex', 'flex-col', 'gap-3', 'md:flex-row', 'md:items-start', 'md:justify-between');
                li.dataset.id = registro.id;
                li.dataset.filename = registro.nombre_archivo || '';
                li.dataset.mimetype = registro.mime_type || '';

                const contentDiv = document.createElement('div');
                contentDiv.classList.add('flex-grow', 'w-full'); 

                const headerInnerDiv = document.createElement('div');
                headerInnerDiv.classList.add('flex', 'flex-col', 'md:flex-row', 'md:items-center', 'md:justify-between', 'gap-2', 'mb-2');

                const titleSpan = document.createElement('span');
                titleSpan.classList.add('registro-title', 'text-lg', 'font-bold', 'text-gray-800'); 
                titleSpan.textContent = registro.titulo;

                const dateAndTypeDiv = document.createElement('div');
                dateAndTypeDiv.classList.add('flex', 'flex-row', 'gap-2', 'items-center'); 

                const dateSpan = document.createElement('span');
                dateSpan.classList.add('registro-date', 'text-sm', 'text-gray-600', 'bg-gray-100', 'px-2', 'py-1', 'rounded-full');
                const dayFormatted = registroDateObj.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric' });
                dateSpan.textContent = `Día: ${dayFormatted.charAt(0).toUpperCase() + dayFormatted.slice(1).replace('.', '')}`; 

                const typeSpan = document.createElement('span');
                typeSpan.classList.add('registro-type', 'text-xs', 'font-medium', 'text-indigo-700', 'bg-indigo-100', 'px-2', 'py-1', 'rounded-full');
                typeSpan.textContent = registro.tipo || 'General';

                dateAndTypeDiv.appendChild(dateSpan);
                dateAndTypeDiv.appendChild(typeSpan);

                headerInnerDiv.appendChild(titleSpan);
                headerInnerDiv.appendChild(dateAndTypeDiv);

                const descriptionP = document.createElement('p');
                descriptionP.classList.add('registro-description', 'text-gray-700', 'text-sm', 'mt-2'); 
                descriptionP.textContent = registro.descripcion || 'Sin descripción.';

                contentDiv.appendChild(headerInnerDiv);
                contentDiv.appendChild(descriptionP);

                const rightSection = document.createElement('div');
                rightSection.classList.add('flex', 'flex-col', 'items-end', 'gap-3', 'md:ml-4', 'mt-4', 'md:mt-0', 'w-full', 'md:w-auto'); 

                const actionsDiv = document.createElement('div');
                actionsDiv.classList.add('registro-actions', 'flex', 'gap-2', 'flex-wrap', 'justify-end', 'w-full'); 

                const baseButtonClasses = 'px-3 py-1 rounded-md text-sm font-semibold flex items-center gap-1 transition-colors duration-200';

                const deleteButton = document.createElement('button');
                deleteButton.classList.add('bg-red-500', 'hover:bg-red-600', 'text-white', baseButtonClasses);
                deleteButton.innerHTML = '<i class="fas fa-trash"></i> Eliminar';
                deleteButton.title = 'Eliminar Registro';
                deleteButton.addEventListener('click', () => deleteRegistro(registro.id));
                actionsDiv.appendChild(deleteButton);

                if (registro.imagen_base64) {
                    const downloadButton = document.createElement('button');
                    downloadButton.classList.add('bg-blue-500', 'hover:bg-blue-600', 'text-white', baseButtonClasses);
                    downloadButton.innerHTML = '<i class="fas fa-download"></i> Descargar';
                    downloadButton.title = 'Descargar Archivo/Imagen';
                    downloadButton.addEventListener('click', () => downloadFile(registro.imagen_base64, registro.nombre_archivo, registro.mime_type));
                    actionsDiv.appendChild(downloadButton);
                }

                const whatsappButton = document.createElement('button');
                whatsappButton.classList.add('bg-green-500', 'hover:bg-green-600', 'text-white', baseButtonClasses);
                whatsappButton.innerHTML = '<i class="fab fa-whatsapp"></i> WhatsApp';
                whatsappButton.title = 'Compartir por WhatsApp';
                whatsappButton.addEventListener('click', () => shareViaWhatsApp(registro.titulo, registro.descripcion));
                actionsDiv.appendChild(whatsappButton);

                rightSection.appendChild(actionsDiv);

                if (registro.imagen_base64 && registro.mime_type) {
                    const fileContainer = document.createElement('div');
                    fileContainer.classList.add('registro-image-container', 'w-full', 'md:max-w-[150px]', 'mt-2', 'md:mt-0'); 
                    if (registro.mime_type.startsWith('image/')) {
                        const img = document.createElement('img');
                        img.classList.add('registro-image', 'w-full', 'h-auto', 'object-cover'); 
                        img.src = registro.imagen_base64;
                        img.alt = 'Imagen adjunta al registro';
                        fileContainer.appendChild(img);
                    } else {
                        const fileInfoP = document.createElement('p');
                        fileInfoP.classList.add('text-xs', 'text-gray-500', 'text-center', 'break-words');
                        fileInfoP.textContent = `Archivo: ${registro.nombre_archivo || 'Sin nombre'} (${registro.mime_type})`;
                        const fileIcon = document.createElement('i');
                        fileIcon.classList.add('fas', 'text-3xl', 'text-gray-400', 'mb-2');
                        if (registro.mime_type.includes('pdf')) fileIcon.classList.add('fa-file-pdf');
                        else if (registro.mime_type.includes('word') || registro.mime_type.includes('document')) fileIcon.classList.add('fa-file-word');
                        else if (registro.mime_type.includes('text')) fileIcon.classList.add('fa-file-alt');
                        else fileIcon.classList.add('fa-file'); 
                        
                        const iconContainer = document.createElement('div');
                        iconContainer.classList.add('flex', 'justify-center', 'items-center', 'mb-2');
                        iconContainer.appendChild(fileIcon);

                        fileContainer.appendChild(iconContainer);
                        fileContainer.appendChild(fileInfoP);
                    }
                    rightSection.appendChild(fileContainer);
                }

                li.appendChild(contentDiv);
                li.appendChild(rightSection);
                registrosList.appendChild(li);
            });
        }

        async function deleteRegistro(registroId) {
            const confirmAction = await showCustomConfirm('¿Estás seguro de que quieres eliminar este registro importante?');
            if (confirmAction) {
                try {
                    const response = await fetch(`/api/registros_importantes/${registroId}`, {
                        method: 'DELETE'
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Error al eliminar el registro.');
                    }
                    showCustomAlert('Registro eliminado con éxito.', 'Eliminación Exitosa');
                    fetchAndRenderAllData(); // Recargar la lista
                } catch (error) {
                    console.error('Error al eliminar registro:', error);
                    showCustomAlert(`No se pudo eliminar el registro: ${error.message}`, 'Error de Eliminación');
                }
            }
        }

        // --- Funcionalidad de Descarga de Archivo ---
        function downloadFile(base64Data, filename, mimeType) {
            if (!base64Data) {
                showCustomAlert('No hay datos para descargar.', 'Error de Descarga');
                return;
            }
            const link = document.createElement('a');
            link.href = base64Data; 
            link.download = filename || `documento_descargado.${mimeType ? mimeType.split('/')[1] : 'bin'}`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showCustomAlert('Documento descargado con éxito.', 'Descarga Completa');
        }

        // --- Funcionalidad de Compartir por WhatsApp ---
        function shareViaWhatsApp(title, description) {
            const textToShare = `*Registro Importante:* ${title}\n\n${description}\n\n[Consulta tu agenda para más detalles]`;
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(textToShare)}`;
            
            const newWindow = window.open(whatsappUrl, '_blank');
            if (!newWindow || newWindow.closed || typeof newWindow.closed=='undefined') {
                window.location.href = whatsappUrl;
            }
        }


        // --- Event Listeners ---
        prevMonthButton.addEventListener('click', () => {
            currentDisplayDate.setMonth(currentDisplayDate.getMonth() - 1);
            updateMonthYearDisplay();
            renderRegistros(); 
        });

        nextMonthButton.addEventListener('click', () => {
            currentDisplayDate.setMonth(currentDisplayDate.getMonth() + 1);
            updateMonthYearDisplay();
            renderRegistros(); 
        });

        filterTipoSelect.addEventListener('change', () => {
            renderRegistros(); 
        });

        addRegistroForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const fecha = registroAddFecha.value;
            const titulo = registroAddTitulo.value.trim();
            const descripcion = registroAddDescripcion.value.trim();
            const tipo = registroAddTipo.value;

            if (!fecha || !titulo) {
                showCustomAlert('Fecha y Título son obligatorios.', 'Campos Obligatorios');
                return;
            }

            try {
                const response = await fetch('/api/registros_importantes/add_from_task', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fecha: fecha,
                        titulo: titulo,
                        descripcion: descripcion,
                        tipo: tipo,
                        imagen_base64: currentFileBase64, 
                        nombre_archivo: currentFileName,    
                        mime_type: currentMimeType          
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error desconocido al guardar el registro.');
                }
                showCustomAlert('Registro guardado con éxito.', 'Guardado Exitoso');
                // Limpiar formulario
                addRegistroForm.reset();
                currentFileBase64 = null;
                currentFileName = null;
                currentMimeType = null;
                clearFilePreview();
                registroAddTipo.value = 'General'; 
                fetchAndRenderAllData(); 
            } catch (error) {
                console.error('Error al guardar el registro:', error);
                showCustomAlert(`No se pudo guardar el registro: ${error.message}`, 'Error de Guardado');
            }
        });


        document.addEventListener('DOMContentLoaded', async () => {
            updateMonthYearDisplay(); 
            registroAddFecha.value = new Date().toISOString().substring(0, 10); // Set default date to today
            // fetchTiposRegistro() se llama después del login
            // fetchAndRenderAllData() se llama después del login
        });
    </script>
</body>
</html>
