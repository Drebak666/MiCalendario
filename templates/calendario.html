<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Calendario de Tareas</title>
<style>
    body {
      background-color: white;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .btn-volver {
      position: fixed;
      bottom: 20px;
      right: 20px;
      font-size: 120px;
      font-weight: bold;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 50%;
      width: 120px;
      height: 120px;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s ease;
      user-select: none;
    }

    .btn-volver:hover {
      background-color: #45a049;
    }

    #calendar {
      margin-top: 20px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 40px;
      table-layout: fixed;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      height: 60px;
      text-align: center;
      word-wrap: break-word;
    }

    td:hover {
      background-color: #eee;
      cursor: pointer;
    }

    .selected {
      background-color: #2196F3;
      color: white;
      font-weight: bold;
    }

    .tarea-form {
      margin-top: 30px;
      text-align: center;
      width: 100%;
      max-width: 800px;
    }

    #tareaInput {
      width: 100%;
      padding: 14px;
      font-size: 42px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    .btn-guardar {
      padding: 14px 24px;
      font-size: 50px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    .btn-guardar:hover {
      background-color: #45a049;
    }

    .tarea-confirmacion {
      color: green;
      margin-top: 10px;
      font-size: 20px;
    }

    .tarea-item {
      background-color: #f0f0f0;
      margin-top: 5px;
      padding: 8px;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 50px;
    }

    .tarea-item button {
      background-color: red;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 6px 12px;
      font-size: 50px;
      cursor: pointer;
    }

    .selector-container {
      font-size: 28px;
      margin-top: 20px;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: center;
    }

    .selector-container select,
    .selector-container button {
      font-size: 50px;
      padding: 10px 20px;
      border-radius: 8px;
      border: 1px solid #ccc;
      cursor: pointer;
    }
  </style>

</head>
<body>
<h1>Calendario de Tareas</h1>
<div id="fechaSeleccionada" style="font-size:1.6rem; margin-bottom: 10px;"></div>

<table id="calendario"></table>

<input type="text" id="tareaInput" placeholder="Escribe una tarea y pulsa Guardar" autocomplete="off" />
<button id="guardarBtn">Guardar Tarea</button>

<div id="listaTareas"></div>

<script>
  const calendario = document.getElementById('calendario');
  const fechaSeleccionadaDiv = document.getElementById('fechaSeleccionada');
  const tareaInput = document.getElementById('tareaInput');
  const guardarBtn = document.getElementById('guardarBtn');
  const listaTareas = document.getElementById('listaTareas');

  let hoy = new Date();
  let mes = hoy.getMonth();
  let anio = hoy.getFullYear();
  let diaSeleccionado = hoy.getDate();

  let diasConTareas = [];

  function fechaString(dia, mes, anio) {
    mes = mes + 1;
    if (mes < 10) mes = '0' + mes;
    if (dia < 10) dia = '0' + dia;
    return `${anio}-${mes}-${dia}`;
  }

  const diasSemana = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];

  function mostrarFechaSeleccionada() {
    const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const fecha = new Date(anio, mes, diaSeleccionado);
    fechaSeleccionadaDiv.textContent = fecha.toLocaleDateString('es-ES', opciones);
  }

  async function cargarDiasConTareas() {
    const mesStr = `${anio}-${(mes + 1).toString().padStart(2, '0')}`;
    const res = await fetch(`/api/tareas-mes/${mesStr}`);
    if (res.ok) {
      diasConTareas = await res.json();
    } else {
      diasConTareas = [];
    }
  }

  async function cargarTareas(fecha) {
    const res = await fetch(`/api/tareas/${fecha}`);
    if (res.ok) {
      const tareas = await res.json();
      mostrarTareas(tareas);
    } else {
      listaTareas.innerHTML = '<p>Error cargando tareas</p>';
    }
  }

  function mostrarTareas(tareas) {
    listaTareas.innerHTML = '';
    if (tareas.length === 0) {
      listaTareas.textContent = 'No hay tareas para este día.';
      return;
    }
    tareas.forEach(tarea => {
      const div = document.createElement('div');
      div.className = 'tarea-item';
      div.textContent = tarea.texto;
      const btnBorrar = document.createElement('button');
      btnBorrar.textContent = 'Borrar';
      btnBorrar.onclick = () => borrarTarea(tarea.id);
      div.appendChild(btnBorrar);
      listaTareas.appendChild(div);
    });
  }

  async function borrarTarea(id) {
    const res = await fetch(`/api/tareas/${id}`, { method: 'DELETE' });
    if (res.ok) {
      cargarTareas(fechaString(diaSeleccionado, mes, anio));
      cargarDiasConTareas().then(dibujarCalendario);
    } else {
      alert('Error borrando tarea');
    }
  }

  async function guardarTarea() {
    const texto = tareaInput.value.trim();
    if (!texto) return alert('Escribe una tarea');
    const fecha = fechaString(diaSeleccionado, mes, anio);
    const res = await fetch('/api/tareas', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ fecha, texto })
    });
    if (res.ok) {
      tareaInput.value = '';
      cargarTareas(fecha);
      cargarDiasConTareas().then(dibujarCalendario);
    } else {
      alert('Error guardando tarea');
    }
  }

  guardarBtn.onclick = guardarTarea;

  function dibujarCalendario() {
    calendario.innerHTML = '';

    let thead = document.createElement('thead');
    let tr = document.createElement('tr');
    for (let d = 0; d < 7; d++) {
      let th = document.createElement('th');
      th.textContent = diasSemana[d];
      tr.appendChild(th);
    }
    thead.appendChild(tr);
    calendario.appendChild(thead);

    let primerDia = new Date(anio, mes, 1);
    let primerDiaSemana = primerDia.getDay();
    if (primerDiaSemana === 0) primerDiaSemana = 7;

    let diasMes = new Date(anio, mes + 1, 0).getDate();

    let tbody = document.createElement('tbody');
    let diaContador = 1;
    for (let fila = 0; fila < 6; fila++) {
      let tr = document.createElement('tr');
      for (let col = 1; col <= 7; col++) {
        let td = document.createElement('td');

        if (fila === 0 && col < primerDiaSemana) {
          td.textContent = '';
          td.style.cursor = 'default';
        } else if (diaContador > diasMes) {
          td.textContent = '';
          td.style.cursor = 'default';
        } else {
          td.textContent = diaContador;

          const fechaCompara = fechaString(diaContador, mes, anio);
          const fechaHoy = fechaString(hoy.getDate(), hoy.getMonth(), hoy.getFullYear());

          if (fechaCompara === fechaHoy) {
            td.classList.add('hoy');
          }

          if (diasConTareas.includes(fechaCompara)) {
            td.classList.add('con-tareas');
          }

          if (diaContador === diaSeleccionado) {
            td.classList.add('selected');
          }

          td.onclick = () => {
            diaSeleccionado = diaContador;
            mostrarFechaSeleccionada();
            cargarTareas(fechaString(diaSeleccionado, mes, anio));
            dibujarCalendario();
          };

          diaContador++;
        }
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
    calendario.appendChild(tbody);
  }

  mostrarFechaSeleccionada();
  cargarDiasConTareas().then(() => {
    dibujarCalendario();
    cargarTareas(fechaString(diaSeleccionado, mes, anio));
  });
</script>

</body>
</html>
