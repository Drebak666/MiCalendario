<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Calendario de Tareas</title>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    max-width: 900px;
    margin: auto;
  }

  h1 {
    font-size: 2.5rem;
    margin-bottom: 20px;
  }

  button {
    font-size: 1.3rem;
    padding: 8px 16px;
    cursor: pointer;
  }

  #tareaInput {
    width: 100%;
    font-size: 1.4rem;
    padding: 10px;
    margin-bottom: 15px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 1.3rem;
  }

  th, td {
    width: 14.28%;
    height: 55px;
    text-align: center;
    border: 1px solid #ccc;
    vertical-align: middle;
    cursor: pointer;
    user-select: none;
    font-weight: bold;
  }

  /* Día actual: fondo azul fuerte con texto blanco */
  td.hoy {
    background-color: #1976d2;
    color: white;
  }

  /* Día seleccionado: gris clarito */
  td.selected {
    background-color: #d3d3d3;
    color: #333;
  }

  /* Días con tareas: fondo azul claro */
  td.con-tareas {
    background-color: #bbdefb;
    font-weight: bolder;
  }

  /* Botón borrar tareas */
  .tarea-item button {
    font-size: 1.2rem;
    background-color: #e53935;
    border: none;
    color: white;
    padding: 3px 8px;
    border-radius: 4px;
    cursor: pointer;
    margin-left: 8px;
  }

  .tarea-item button:hover {
    background-color: #b71c1c;
  }

  #listaTareas {
    margin-top: 20px;
    font-size: 1.3rem;
  }

  .tarea-item {
    margin-bottom: 10px;
  }
</style>
</head>
<body>
<h1>Calendario de Tareas</h1>
<div id="fechaSeleccionada" style="font-size:1.6rem; margin-bottom: 10px;"></div>

<table id="calendario"></table>

<input type="text" id="tareaInput" placeholder="Escribe una tarea y pulsa Guardar" autocomplete="off" />
<button id="guardarBtn">Guardar Tarea</button>

<div id="listaTareas"></div>

<script>
  const calendario = document.getElementById('calendario');
  const fechaSeleccionadaDiv = document.getElementById('fechaSeleccionada');
  const tareaInput = document.getElementById('tareaInput');
  const guardarBtn = document.getElementById('guardarBtn');
  const listaTareas = document.getElementById('listaTareas');

  let hoy = new Date();
  let mes = hoy.getMonth();
  let anio = hoy.getFullYear();
  let diaSeleccionado = hoy.getDate();

  let diasConTareas = [];

  function fechaString(dia, mes, anio) {
    mes = mes + 1;
    if (mes < 10) mes = '0' + mes;
    if (dia < 10) dia = '0' + dia;
    return `${anio}-${mes}-${dia}`;
  }

  const diasSemana = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];

  function mostrarFechaSeleccionada() {
    const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const fecha = new Date(anio, mes, diaSeleccionado);
    fechaSeleccionadaDiv.textContent = fecha.toLocaleDateString('es-ES', opciones);
  }

  async function cargarDiasConTareas() {
    const mesStr = `${anio}-${(mes + 1).toString().padStart(2, '0')}`;
    const res = await fetch(`/api/tareas-mes/${mesStr}`);
    if (res.ok) {
      diasConTareas = await res.json();
    } else {
      diasConTareas = [];
    }
  }

  async function cargarTareas(fecha) {
    const res = await fetch(`/api/tareas/${fecha}`);
    if (res.ok) {
      const tareas = await res.json();
      mostrarTareas(tareas);
    } else {
      listaTareas.innerHTML = '<p>Error cargando tareas</p>';
    }
  }

  function mostrarTareas(tareas) {
    listaTareas.innerHTML = '';
    if (tareas.length === 0) {
      listaTareas.textContent = 'No hay tareas para este día.';
      return;
    }
    tareas.forEach(tarea => {
      const div = document.createElement('div');
      div.className = 'tarea-item';
      div.textContent = tarea.texto;
      const btnBorrar = document.createElement('button');
      btnBorrar.textContent = 'Borrar';
      btnBorrar.onclick = () => borrarTarea(tarea.id);
      div.appendChild(btnBorrar);
      listaTareas.appendChild(div);
    });
  }

  async function borrarTarea(id) {
    const res = await fetch(`/api/tareas/${id}`, { method: 'DELETE' });
    if (res.ok) {
      cargarTareas(fechaString(diaSeleccionado, mes, anio));
      cargarDiasConTareas().then(dibujarCalendario);
    } else {
      alert('Error borrando tarea');
    }
  }

  async function guardarTarea() {
    const texto = tareaInput.value.trim();
    if (!texto) return alert('Escribe una tarea');
    const fecha = fechaString(diaSeleccionado, mes, anio);
    const res = await fetch('/api/tareas', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ fecha, texto })
    });
    if (res.ok) {
      tareaInput.value = '';
      cargarTareas(fecha);
      cargarDiasConTareas().then(dibujarCalendario);
    } else {
      alert('Error guardando tarea');
    }
  }

  guardarBtn.onclick = guardarTarea;

  function dibujarCalendario() {
    calendario.innerHTML = '';

    let thead = document.createElement('thead');
    let tr = document.createElement('tr');
    for (let d = 0; d < 7; d++) {
      let th = document.createElement('th');
      th.textContent = diasSemana[d];
      tr.appendChild(th);
    }
    thead.appendChild(tr);
    calendario.appendChild(thead);

    let primerDia = new Date(anio, mes, 1);
    let primerDiaSemana = primerDia.getDay();
    if (primerDiaSemana === 0) primerDiaSemana = 7;

    let diasMes = new Date(anio, mes + 1, 0).getDate();

    let tbody = document.createElement('tbody');
    let diaContador = 1;
    for (let fila = 0; fila < 6; fila++) {
      let tr = document.createElement('tr');
      for (let col = 1; col <= 7; col++) {
        let td = document.createElement('td');

        if (fila === 0 && col < primerDiaSemana) {
          td.textContent = '';
          td.style.cursor = 'default';
        } else if (diaContador > diasMes) {
          td.textContent = '';
          td.style.cursor = 'default';
        } else {
          td.textContent = diaContador;

          const fechaCompara = fechaString(diaContador, mes, anio);
          const fechaHoy = fechaString(hoy.getDate(), hoy.getMonth(), hoy.getFullYear());

          if (fechaCompara === fechaHoy) {
            td.classList.add('hoy');
          }

          if (diasConTareas.includes(fechaCompara)) {
            td.classList.add('con-tareas');
          }

          if (diaContador === diaSeleccionado) {
            td.classList.add('selected');
          }

          td.onclick = () => {
            diaSeleccionado = diaContador;
            mostrarFechaSeleccionada();
            cargarTareas(fechaString(diaSeleccionado, mes, anio));
            dibujarCalendario();
          };

          diaContador++;
        }
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
    calendario.appendChild(tbody);
  }

  mostrarFechaSeleccionada();
  cargarDiasConTareas().then(() => {
    dibujarCalendario();
    cargarTareas(fechaString(diaSeleccionado, mes, anio));
  });
</script>

</body>
</html>
