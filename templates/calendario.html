<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario - Mi Agenda</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" xintegrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
    <div class="calendar-container">
        <div class="calendar-header">
            <div class="month-navigation">
                <button id="prevMonth" class="nav-btn"><i class="fas fa-chevron-left"></i></button>
                <h2 id="currentMonthYear"></h2>
                <button id="nextMonth" class="nav-btn"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="year-selection">
                <select id="yearSelect"></select>
                <button id="todayButton" class="boton today-btn">Hoy</button>
            </div>
        </div>

        <div class="calendar-body" id="calendarBody">
            <div class="day-name">Dom</div>
            <div class="day-name">Lun</div>
            <div class="day-name">Mar</div>
            <div class="day-name">Mié</div>
            <div class="day-name">Jue</div>
            <div class="day-name">Vie</div>
            <div class="day-name">Sáb</div>
            <!-- Los días se generarán aquí por JavaScript -->
        </div>
    </div>

    <!-- Panel para detalles del día -->
    <div id="dayDetailsPanel" class="day-details-panel">
        <h3 id="panelDate">Selecciona un día para ver los detalles</h3>
        <div id="panelContent">
            <!-- Tareas y Rutinas combinadas bajo un solo título -->
            <h4>Actividades del día:</h4>
            <ul id="panelActivitiesList"></ul>
        </div>

        <!-- Formulario Unificado para Tareas y Rutinas en el día seleccionado -->
        <form id="unifiedEntryForm" class="task-form-container">
            <h4 class="form-title">Añadir al día seleccionado:</h4>
            <div class="form-group">
                <label for="entryType">Tipo:</label>
                <select id="entryType">
                    <option value="tarea">Tarea</option>
                    <option value="rutina">Rutina</option>
                </select>
            </div>

            <div class="form-group">
                <label for="entryTextInput" id="entryTextLabel">Descripción:</label>
                <input type="text" id="entryTextInput" placeholder="Añadir una nueva tarea o rutina..." required>
            </div>

            <div class="form-group time-and-list-group">
                <label for="entryTimeInput">Hora:</label>
                <input type="time" id="entryTimeInput">
            </div>

            <!-- Campos de Rutina (inicialmente ocultos) -->
            <div id="routineFields" style="display: none;">
                <div class="form-group day-selector">
                    <p>Repetir los días (solo para crear nuevas rutinas globales):</p>
                    <label><input type="checkbox" name="routineDay" value="Lunes"> <span>Lunes</span></label>
                    <label><input type="checkbox" name="routineDay" value="Martes"> <span>Martes</span></label>
                    <label><input type="checkbox" name="routineDay" value="Miércoles"> <span>Miércoles</span></label>
                    <label><input type="checkbox" name="routineDay" value="Jueves"> <span>Jueves</span></label>
                    <label><input type="checkbox" name="routineDay" value="Viernes"> <span>Viernes</span></label>
                    <label><input type="checkbox" name="routineDay" value="Sábado"> <span>Sábado</span></label>
                    <label><input type="checkbox" name="routineDay" value="Domingo"> <span>Domingo</span></label>
                </div>
            </div>

            <button type="submit" class="boton">Guardar en este día</button>
        </form>
    </div>

    <div class="navigation">
        <a href="/" class="boton"><i class="fas fa-home"></i> Volver al Inicio</a>
        <a href="/alimentacion" class="boton"><i class="fas fa-utensils"></i> Alimentación</a>
        <a href="/documentos" class="boton"><i class="fas fa-folder-open"></i> Documentos</a>
        <a href="/gimnasio" class="boton"><i class="fas fa-dumbbell"></i> Gimnasio</a>
        <a href="/lista" class="boton"><i class="fas fa-shopping-cart"></i> Lista de Compra</a>
    </div>

    <script>
        const calendarBody = document.getElementById('calendarBody');
        const currentMonthYear = document.getElementById('currentMonthYear');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        const yearSelect = document.getElementById('yearSelect');
        const todayButton = document.getElementById('todayButton');

        // Referencias al nuevo panel de detalles
        const dayDetailsPanel = document.getElementById('dayDetailsPanel');
        const panelDateElem = document.getElementById('panelDate');
        const panelActivitiesList = document.getElementById('panelActivitiesList'); // Renombrado a panelActivitiesList

        // Referencias a los elementos del formulario
        const unifiedEntryForm = document.getElementById('unifiedEntryForm');
        const entryTypeSelect = document.getElementById('entryType');
        const entryTextInput = document.getElementById('entryTextInput');
        const entryTextLabel = document.getElementById('entryTextLabel');
        const entryTimeInput = document.getElementById('entryTimeInput');
        const routineFieldsDiv = document.getElementById('routineFields');
        const routineDayCheckboxes = document.querySelectorAll('input[name="routineDay"]');
        
        let currentYear, currentMonth; // 0-indexed month
        let selectedDayFormattedDate = null; // Para rastrear el día seleccionado y usarlo en el formulario

        // Variables para almacenar días con actividades
        let daysWithTasks = [];

        // Variable para el intervalo de actualización de tiempo restante
        let timeLeftUpdateInterval;

        const dayNameToNumber = {
            'Domingo': 0, 'Lunes': 1, 'Martes': 2, 'Miércoles': 3, 'Jueves': 4, 'Viernes': 5, 'Sábado': 6
        };
        const dayNumberToName = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];

        function formatFecha(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        async function fetchDaysWithActivities() {
            try {
                const tasksPromise = fetch(`/api/tareas/dias_con_tareas/${currentYear}/${currentMonth + 1}`);
                const [tasksResponse] = await Promise.all([tasksPromise]); 

                if (tasksResponse.ok) {
                    daysWithTasks = await tasksResponse.json();
                } else {
                    console.error('Error al obtener días con tareas:', await tasksResponse.text());
                    daysWithTasks = [];
                }
            } catch (error) {
                console.error('Error general al obtener días con actividades:', error);
                daysWithTasks = [];
            }
        }

        async function renderCalendar() {
            calendarBody.querySelectorAll('.day').forEach(day => day.remove()); // Limpiar días anteriores

            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const numDaysInMonth = lastDay.getDate();

            const firstDayIndex = firstDay.getDay(); // 0 for Sunday, 1 for Monday, etc.

            // Rellenar días vacíos al principio del mes
            for (let i = 0; i < firstDayIndex; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.classList.add('day', 'empty');
                calendarBody.appendChild(emptyDay);
            }

            await fetchDaysWithActivities(); // Obtener días con actividades antes de renderizar

            // Rellenar días del mes
            for (let i = 1; i <= numDaysInMonth; i++) {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('day');
                dayDiv.textContent = i;

                const dayDate = new Date(currentYear, currentMonth, i);
                const formattedDayDate = formatFecha(dayDate);

                // Marcar si es hoy
                const today = new Date();
                if (dayDate.getDate() === today.getDate() &&
                    dayDate.getMonth() === today.getMonth() &&
                    dayDate.getFullYear() === today.getFullYear()) {
                    dayDiv.classList.add('today');
                }

                // Marcar día seleccionado
                if (formattedDayDate === selectedDayFormattedDate) {
                    dayDiv.classList.add('selected');
                }

                // Marcar días con tareas
                if (daysWithTasks.includes(formattedDayDate)) {
                    dayDiv.classList.add('has-tasks');
                }
                
                dayDiv.addEventListener('click', () => {
                    // Remover clase 'selected' del día previamente seleccionado
                    const prevSelectedDay = document.querySelector('.day.selected');
                    if (prevSelectedDay) {
                        prevSelectedDay.classList.remove('selected');
                    }
                    // Añadir clase 'selected' al día clickeado
                    dayDiv.classList.add('selected');
                    selectedDayFormattedDate = formattedDayDate; // Actualizar día seleccionado
                    showDayDetails(formattedDayDate);
                });
                calendarBody.appendChild(dayDiv);
            }

            currentMonthYear.textContent = new Date(currentYear, currentMonth).toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });

            // Si hay un día seleccionado, recargar sus detalles después de renderizar el calendario
            if (selectedDayFormattedDate) {
                showDayDetails(selectedDayFormattedDate);
            } else {
                // Mostrar mensaje inicial si no hay día seleccionado
                panelDateElem.textContent = 'Selecciona un día para ver los detalles';
                panelActivitiesList.innerHTML = '';
                // También reinicia el formulario si no hay día seleccionado
                resetFormAndPanel();
                if (timeLeftUpdateInterval) {
                    clearInterval(timeLeftUpdateInterval);
                    timeLeftUpdateInterval = null;
                }
            }
        }

        async function showDayDetails(date) {
            selectedDayFormattedDate = date; // Asegurar que el día seleccionado esté actualizado para el formulario
            panelDateElem.textContent = new Date(date).toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            panelActivitiesList.innerHTML = '<li class="mensaje-info">Cargando actividades...</li>'; // Texto unificado
            
            // Scroll al panel de detalles para asegurar visibilidad en móviles
            dayDetailsPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });

            try {
                // Fetch de Tareas
                const tasksResponse = await fetch(`/api/tareas/${date}`);
                if (!tasksResponse.ok) throw new Error('Error al cargar tareas.');
                const tasks = await tasksResponse.json();

                // Fetch de Rutinas (filtramos por el día de la semana de la fecha seleccionada)
                const routinesResponse = await fetch('/api/rutinas');
                if (!routinesResponse.ok) throw new Error('Error al cargar rutinas.');
                const allRoutines = await routinesResponse.json();
                
                const selectedDayOfWeek = new Date(date).getDay(); // 0 for Sunday, 1 for Monday...
                const routinesForSelectedDay = allRoutines.filter(routine => 
                    routine.dias && Array.isArray(routine.dias) && routine.dias.includes(selectedDayOfWeek)
                );

                renderDayDetailsContent(tasks, routinesForSelectedDay, date);
            } catch (error) {
                console.error('Error al obtener detalles del día:', error);
                panelActivitiesList.innerHTML = `<li class="mensaje-info">Error al cargar actividades: ${error.message}</li>`;
            }
        }

        function renderDayDetailsContent(tasks, routines, currentDateString) {
            panelActivitiesList.innerHTML = ''; // Limpiamos la única lista

            const combinedActivities = [
                ...tasks.map(task => ({
                    ...task,
                    type: 'tarea',
                    displayText: task.texto, // Asegurar que displayText existe para tareas
                    displayTime: task.hora   // Asegurar que displayTime existe para tareas
                })),
                ...routines.map(routine => ({
                    ...routine,
                    type: 'rutina',
                    displayText: routine.nombre,
                    displayTime: routine.hora
                }))
            ];

            // Ordenar por hora, tareas completadas al final
            combinedActivities.sort((a, b) => {
                if (a.type === 'tarea' && a.completada && (!b.completada || b.type !== 'tarea')) return 1;
                if (b.type === 'tarea' && b.completada && (!a.completada || b.type !== 'tarea')) return -1;

                const timeA = a.displayTime ? a.displayTime.substring(0, 5) : '24:00'; // Asegurar HH:MM
                const timeB = b.displayTime ? b.displayTime.substring(0, 5) : '24:00'; // Asegurar HH:MM
                const timeCompare = timeA.localeCompare(timeB);
                if (timeCompare !== 0) return timeCompare;

                return (a.displayText || '').localeCompare(b.displayText || '');
            });


            if (combinedActivities.length === 0) {
                panelActivitiesList.innerHTML = '<li class="mensaje-info">No hay actividades programadas para este día.</li>';
            } else {
                combinedActivities.forEach(activity => {
                    const li = document.createElement('li');
                    
                    const contentDiv = document.createElement('div');
                    contentDiv.classList.add('entry-content-wrapper'); 

                    const textSpan = document.createElement('span');
                    textSpan.classList.add('entry-text');
                    const formattedTime = activity.displayTime ? activity.displayTime.substring(0, 5) : ''; // Format HH:MM
                    const horaPrefix = formattedTime ? `<span class="entry-time">${formattedTime}</span> - ` : '';
                    textSpan.innerHTML = `${horaPrefix}${activity.displayText}`;
                    
                    if (activity.type === 'tarea') {
                        li.classList.add('task-item'); 
                        if (activity.completada) {
                            li.classList.add('completada');
                            textSpan.classList.add('completada');
                        }
                    } else if (activity.type === 'rutina') {
                        li.classList.add('routine-item'); 
                    }

                    const timeLeftSpan = document.createElement('span');
                    timeLeftSpan.classList.add('time-left');
                    timeLeftSpan.dataset.taskId = (activity.type === 'tarea') ? activity.id : `routine-cal-${activity.id}`;
                    timeLeftSpan.dataset.taskDate = currentDateString; 
                    timeLeftSpan.dataset.taskTime = activity.displayTime || '';
                    
                    contentDiv.appendChild(textSpan);
                    contentDiv.appendChild(timeLeftSpan);
                    li.appendChild(contentDiv);

                    // Add action buttons
                    const actionsDiv = document.createElement('div');
                    actionsDiv.classList.add('entry-actions');

                    // Delete Button for both tasks and routines
                    const deleteButton = document.createElement('button');
                    deleteButton.classList.add('btn-eliminar');
                    deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i> Eliminar';
                    deleteButton.addEventListener('click', () => deleteActivity(activity.type, activity.id));
                    actionsDiv.appendChild(deleteButton);

                    // Postpone Button only for tasks
                    if (activity.type === 'tarea') {
                        const postponeButton = document.createElement('button');
                        postponeButton.classList.add('boton'); // Using generic boton class for now
                        postponeButton.innerHTML = '<i class="fas fa-calendar-alt"></i> Aplazar';
                        postponeButton.addEventListener('click', () => postponeTask(activity.id, currentDateString, activity.hora, activity.texto));
                        actionsDiv.appendChild(postponeButton);

                        // Complete/Uncomplete Button for tasks
                        const completeButton = document.createElement('button');
                        completeButton.classList.add('btn-completar');
                        completeButton.dataset.id = activity.id;
                        completeButton.textContent = activity.completada ? 'Descompletar' : 'Completar';
                        if (activity.completada) completeButton.classList.add('completada');
                        completeButton.addEventListener('click', () => toggleTaskCompletada(activity.id));
                        actionsDiv.appendChild(completeButton);

                        // Save to Registro Button for tasks
                        const saveRegistroButton = document.createElement('button');
                        saveRegistroButton.classList.add('btn-guardar-registro-icon');
                        saveRegistroButton.dataset.id = activity.id;
                        saveRegistroButton.title = 'Guardar en Registro';
                        saveRegistroButton.innerHTML = '<i class="fas fa-save"></i>';
                        saveRegistroButton.addEventListener('click', () => saveTaskToRegistro(activity.id, currentDateString, activity.hora, activity.texto));
                        actionsDiv.appendChild(saveRegistroButton);
                    }
                    
                    li.appendChild(actionsDiv);
                    panelActivitiesList.appendChild(li);
                });
            }

            // Actualizar el intervalo para el tiempo restante: ¡cada 10 segundos!
            if (timeLeftUpdateInterval) {
                clearInterval(timeLeftUpdateInterval);
                timeLeftUpdateInterval = null;
            }
            timeLeftUpdateInterval = setInterval(updateAllTimeLeftCountersInPanel, 10 * 1000); // 10 segundos
            updateAllTimeLeftCountersInPanel(); 
        }

        // Función para actualizar el tiempo restante (adaptada para el calendario)
        function updateTimeLeft(itemId, itemDate, itemTime) {
            // Buscar elementos de tiempo restante dentro del panel de detalles
            const targetElement = document.querySelector(`#dayDetailsPanel .time-left[data-task-id="${itemId}"]`);
            if (!targetElement) { // Si no se encuentra el elemento, salir
                return;
            }
            
            // Verificar si el elemento padre está completado (solo aplica a tareas)
            const parentItem = targetElement.closest('.task-item') || targetElement.closest('.routine-item');
            if (parentItem && parentItem.classList.contains('completada')) {
                targetElement.textContent = ''; // Limpiar el tiempo si la tarea está completada
                return;
            }

            const now = new Date();
            let year, month, day, hours, minutes;

            const dateParts = itemDate.split('-');
            year = parseInt(dateParts[0]);
            month = parseInt(dateParts[1]) - 1; 
            day = parseInt(dateParts[2]);

            // Ensure itemTime is HH:MM before parsing
            let formattedItemTime = typeof itemTime === 'string' && itemTime.length >= 5 ? itemTime.substring(0, 5) : '';

            if (formattedItemTime.match(/^\d{2}:\d{2}$/)) {
                const timeParts = formattedItemTime.split(':');
                hours = parseInt(timeParts[0]);
                minutes = parseInt(timeParts[1]);
            } else {
                hours = 23;
                minutes = 59;
            }
            
            const itemMoment = new Date(year, month, day, hours, minutes, 0); 

            if (isNaN(itemMoment.getTime())) { 
                targetElement.textContent = '(Fecha/Hora Inválida)';
                targetElement.style.color = '#dc3545';
                if (parentItem) parentItem.querySelector('.entry-text').classList.add('vencida');
                return;
            }

            if (itemMoment < now) {
                targetElement.textContent = '(Vencida)';
                targetElement.style.color = '#dc3545';
                if (parentItem) parentItem.querySelector('.entry-text').classList.add('vencida');
                return;
            }

            const diffMs = itemMoment - now;
            const days = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const hoursLeft = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutesLeft = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

            let timeLeftText = '';
            if (days > 0) {
                timeLeftText = `(${days} día${days !== 1 ? 's' : ''})`;
            } else if (hoursLeft > 0) {
                timeLeftText = `(${hoursLeft}h ${minutesLeft}m)`;
            } else if (minutesLeft > 0) {
                timeLeftText = `(${minutesLeft}m)`;
            } else {
                timeLeftText = '(Menos de 1m)';
            }

            targetElement.textContent = timeLeftText;
            targetElement.style.color = '#007bff';
            if (parentItem) parentItem.querySelector('.entry-text').classList.remove('vencida');
        }

        // Función para actualizar todos los contadores de tiempo restante DENTRO DEL PANEL
        function updateAllTimeLeftCountersInPanel() {
            const activeTimeSpans = document.querySelectorAll('#dayDetailsPanel .time-left');
            activeTimeSpans.forEach(span => {
                const itemId = span.dataset.taskId;
                const itemDate = span.dataset.taskDate;
                const itemTime = span.dataset.taskTime;
                updateTimeLeft(itemId, itemDate, itemTime);
            });
        }

        // --- Funciones de Modal y Confirmación ---
        function createModal(content) {
            const modalOverlay = document.createElement('div');
            modalOverlay.classList.add('custom-modal-overlay');

            const modalContent = document.createElement('div');
            modalContent.classList.add('custom-modal-content');
            modalContent.appendChild(content);

            modalOverlay.appendChild(modalContent);

            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    modalOverlay.remove();
                }
            });
            return modalOverlay;
        }

        function showCustomConfirm(message) {
            return new Promise((resolve) => {
                const confirmContent = document.createElement('div');
                confirmContent.innerHTML = `
                    <h3>Confirmación</h3>
                    <p>${message}</p>
                    <div class="modal-actions">
                        <button id="confirmYes" class="boton">Sí</button>
                        <button id="confirmNo" class="boton cancel-button">No</button>
                    </div>
                `;
                const confirmModal = createModal(confirmContent);
                document.body.appendChild(confirmModal);

                document.getElementById('confirmYes').addEventListener('click', () => {
                    confirmModal.remove();
                    resolve(true);
                });
                document.getElementById('confirmNo').addEventListener('click', () => {
                    confirmModal.remove();
                    resolve(false);
                });
            });
        }

        // --- Funciones de Acción (Eliminar / Aplazar / Completar / Guardar Registro) ---
        async function deleteActivity(type, id) {
            const confirmMessage = type === 'tarea' ? '¿Estás seguro de que quieres eliminar esta tarea?' : '¿Estás seguro de que quieres eliminar esta rutina?';
            const confirmAction = await showCustomConfirm(confirmMessage);
            if (confirmAction) {
                try {
                    const apiEndpoint = type === 'tarea' ? `/api/tareas/${id}` : `/api/rutinas/${id}`;
                    const response = await fetch(apiEndpoint, { method: 'DELETE' });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `Error al eliminar ${type}.`);
                    }
                    alert(`${type === 'tarea' ? 'Tarea' : 'Rutina'} eliminada con éxito.`);
                    showDayDetails(selectedDayFormattedDate); // Re-render current day details
                    renderCalendar(); // Re-render calendar to update task marks
                } catch (error) {
                    console.error(`Error al eliminar ${type}:`, error);
                    alert(`No se pudo eliminar ${type}. Error: ${error.message}`);
                }
            }
        }

        async function postponeTask(taskId, currentFecha, currentHora, currentTexto) {
            const confirmAction = await showCustomConfirm(`¿Estás seguro de que quieres aplazar la tarea "${currentTexto}"?`);
            if (!confirmAction) {
                return;
            }

            const formContent = document.createElement('div');
            formContent.innerHTML = `
                <h3>Aplazar Tarea</h3>
                <p>Tarea: <strong>${currentTexto}</strong></p>
                <div class="form-group">
                    <label for="newFecha">Nueva Fecha:</label>
                    <input type="date" id="newFecha" value="${currentFecha}" required>
                </div>
                <div class="form-group">
                    <label for="newHora">Nueva Hora (opcional):</label>
                    <input type="time" id="newHora" value="${currentHora ? currentHora.substring(0, 5) : ''}">
                </div>
                <div class="modal-actions">
                    <button id="aplazarBtn" class="boton">Aplazar</button>
                    <button id="cancelAplazarBtn" class="boton cancel-button">Cancelar</button>
                </div>
            `;

            const modal = createModal(formContent);
            document.body.appendChild(modal);

            // Set min date to today for newFecha input
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            document.getElementById('newFecha').min = `${year}-${month}-${day}`;


            document.getElementById('aplazarBtn').addEventListener('click', async () => {
                const newFecha = document.getElementById('newFecha').value;
                const newHora = document.getElementById('newHora').value;

                if (!newFecha) {
                    alert('Por favor, selecciona una nueva fecha.');
                    return;
                }

                try {
                    const response = await fetch(`/api/tareas/${taskId}/aplazar`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ new_fecha: newFecha, new_hora: newHora || null })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Error desconocido al aplazar la tarea.');
                    }
                    alert('Tarea aplazada con éxito.');
                    modal.remove();
                    // Recargar el día *actual* si la tarea se movió a otro día
                    showDayDetails(selectedDayFormattedDate);
                    // Y también forzar un re-render del calendario para que las marcas se actualicen si la tarea cambió de día
                    renderCalendar();
                } catch (error) {
                    console.error('Error al aplazar la tarea:', error);
                    alert(`No se pudo aplazar la tarea. Error: ${error.message}`);
                }
            });

            document.getElementById('cancelAplazarBtn').addEventListener('click', () => {
                modal.remove();
            });
        }

        async function toggleTaskCompletada(taskId) {
            try {
                const response = await fetch(`/api/tareas/${taskId}/toggle_completada`, {
                    method: 'PATCH',
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error desconocido al actualizar la tarea.');
                }
                showDayDetails(selectedDayFormattedDate); // Recargar la lista unificada
            } catch (error) {
                console.error('Error al cambiar estado:', error);
                alert(`No se pudo actualizar la tarea. Error: ${error.message}`);
            }
        }

        async function saveTaskToRegistro(taskId, currentFecha, currentHora, currentTexto) {
            const formContent = document.createElement('div');
            formContent.innerHTML = `
                <h3>Guardar en Registro Importante</h3>
                <label for="registroTitulo">Título:</label>
                <input type="text" id="registroTitulo" value="${currentTexto}" required>

                <label for="registroDescripcion">Descripción:</label>
                <textarea id="registroDescripcion">Original: "${currentTexto}"${currentHora ? ` (Hora: ${currentHora})` : ''}</textarea>

                <label for="registroTipo">Tipo:</label>
                <select id="registroTipo">
                    <option value="Salud">Salud</option>
                    <option value="Cita">Cita</option>
                    <option value="Escolar">Escolar</option>
                    <option value="General" selected>General</option>
                    <option value="Personal">Personal</option>
                    <option value="Finanzas">Finanzas</option>
                    <option value="Documento">Documento</option>
                </select>

                <div class="modal-actions">
                    <button id="guardarRegistroBtn" class="boton">Guardar</button>
                    <button id="cancelRegistroBtn" class="boton cancel-button">Cancelar</button>
                </div>
            `;

            const modal = createModal(formContent);
            document.body.appendChild(modal);

            document.getElementById('guardarRegistroBtn').addEventListener('click', async () => {
                const titulo = document.getElementById('registroTitulo').value.trim();
                const descripcion = document.getElementById('registroDescripcion').value.trim();
                const tipo = document.getElementById('registroTipo').value;

                if (!titulo) {
                    alert('El título es obligatorio.');
                    return;
                }

                try {
                    const response = await fetch('/api/registros_importantes/add_from_task', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ fecha: currentFecha, titulo, descripcion, tipo })
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Error desconocido al guardar el registro.');
                    }
                    alert('Registro guardado con éxito.');
                    modal.remove();
                } catch (error) {
                    console.error('Error al guardar el registro:', error);
                    alert(`No se pudo guardar el registro: ${error.message}`);
                }
            });

            document.getElementById('cancelRegistroBtn').addEventListener('click', () => {
                modal.remove();
            });
        }


        // --- Lógica del Formulario de Adición ---
        entryTypeSelect.addEventListener('change', () => {
            if (entryTypeSelect.value === 'rutina') {
                routineFieldsDiv.style.display = 'block';
                entryTextLabel.textContent = 'Nombre de la Rutina:';
                entryTextInput.placeholder = 'Ej. Meditar, Correr, Estudiar Inglés';
                entryTimeInput.required = true;
            } else {
                routineFieldsDiv.style.display = 'none';
                entryTextLabel.textContent = 'Descripción:';
                entryTextInput.placeholder = 'Añadir una nueva tarea...';
                entryTimeInput.required = false;
                routineDayCheckboxes.forEach(checkbox => checkbox.checked = false);
            }
        });

        unifiedEntryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!selectedDayFormattedDate) {
                alert('Por favor, selecciona un día en el calendario para añadir una tarea o rutina.');
                return;
            }

            const type = entryTypeSelect.value;
            const text = entryTextInput.value.trim();
            const hora = entryTimeInput.value.trim();

            if (!text) {
                alert('La descripción no puede estar vacía.');
                return;
            }

            if (type === 'tarea') {
                try {
                    const response = await fetch('/api/tareas', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ fecha: selectedDayFormattedDate, texto: text, hora }),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Error desconocido al guardar la tarea.');
                    }
                    alert('Tarea guardada con éxito.');
                    showDayDetails(selectedDayFormattedDate); // Recargar detalles del día
                    renderCalendar(); // Recargar calendario para actualizar marcas de actividad
                } catch (error) {
                    console.error('Error al guardar la tarea:', error);
                    alert(`No se pudo guardar la tarea. Inténtalo de nuevo. Error: ${error.message}`);
                }
            } else if (type === 'rutina') {
                const diasSeleccionados = Array.from(routineDayCheckboxes)
                                               .filter(checkbox => checkbox.checked)
                                               .map(checkbox => dayNameToNumber[checkbox.value]);

                if (!hora || diasSeleccionados.length === 0) {
                    alert('Para una rutina, la hora y al menos un día son obligatorios.');
                    return;
                }

                try {
                    const response = await fetch('/api/rutinas', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ nombre: text, hora, dias: diasSeleccionados }),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Error desconocido al guardar la rutina.');
                    }
                    alert('Rutina guardada con éxito.');
                    renderCalendar(); // Recargar calendario para actualizar marcas de actividad (si aplica)
                } catch (error) {
                    console.error('Error al guardar la rutina:', error);
                    alert(`No se pudo guardar la rutina. Inténtalo de nuevo. Error: ${error.message}`);
                }
            }

            // Restablecer el formulario
            entryTextInput.value = '';
            entryTimeInput.value = '';
            routineDayCheckboxes.forEach(checkbox => checkbox.checked = false);
            entryTypeSelect.value = 'tarea';
            routineFieldsDiv.style.display = 'none';
            entryTextLabel.textContent = 'Descripción:';
            entryTextInput.placeholder = 'Añadir una nueva tarea...';
            entryTimeInput.required = false;
        });

        // Función para reiniciar el formulario y el panel
        function resetFormAndPanel() {
            entryTextInput.value = '';
            entryTimeInput.value = '';
            routineDayCheckboxes.forEach(checkbox => checkbox.checked = false);
            entryTypeSelect.value = 'tarea';
            routineFieldsDiv.style.display = 'none';
            entryTextLabel.textContent = 'Descripción:';
            entryTextInput.placeholder = 'Añadir una nueva tarea...';
            entryTimeInput.required = false;

            panelDateElem.textContent = 'Selecciona un día para ver los detalles';
            panelActivitiesList.innerHTML = ''; // Limpiamos la única lista
            if (timeLeftUpdateInterval) {
                clearInterval(timeLeftUpdateInterval);
                timeLeftUpdateInterval = null;
            }
        }

        prevMonthBtn.addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        });

        nextMonthBtn.addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
        });

        yearSelect.addEventListener('change', (event) => {
            currentYear = parseInt(event.target.value);
            renderCalendar();
        });

        todayButton.addEventListener('click', () => {
            const today = new Date();
            currentYear = today.getFullYear();
            currentMonth = today.getMonth();
            yearSelect.value = currentYear; // Sincroniza el selector de año
            selectedDayFormattedDate = formatFecha(today); // Seleccionar el día actual al hacer clic en "Hoy"
            renderCalendar();
        });


        function initCalendar() {
            const today = new Date();
            currentYear = today.getFullYear();
            currentMonth = today.getMonth(); // 0-indexed

            for (let i = currentYear - 5; i <= currentYear + 5; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                yearSelect.appendChild(option);
            }
            yearSelect.value = currentYear; // Seleccionar el año actual por defecto

            renderCalendar();
        }

        document.addEventListener('DOMContentLoaded', initCalendar);
    </script>
</body>
</html>
