<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Citas Importantes / Salud</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Registros Importantes y de Salud</h1>
        <p>Aquí podrás guardar información relevante como citas médicas, resultados de análisis, eventos importantes, etc.</p>

        <div class="list-section">
            <h2>Mis Registros</h2>
            <ul id="registrosList" class="task-list">
                </ul>
        </div>
        
        <a href="/" class="boton back-button">Volver</a>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            async function loadRegistros() {
                const registrosList = document.getElementById('registrosList');
                registrosList.innerHTML = ''; // Limpiar lista antes de cargar

                try {
                    const response = await fetch('/api/registros_importantes', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Error al cargar los registros.');
                    }

                    const registros = await response.json();
                    if (registros.length === 0) {
                        registrosList.innerHTML = '<li class="no-tasks">No hay registros importantes guardados.</li>';
                        return;
                    }

                    registros.forEach(registro => {
                        const li = document.createElement('li');
                        li.classList.add('task-item'); // Reutilizar estilo de tarea
                        li.innerHTML = `
                            <span class="registro-text">
                                ${registro.fecha} - <strong>${registro.titulo}</strong> (${registro.tipo || 'Sin Tipo'})
                            </span>
                            <span class="registro-description">
                                ${registro.descripcion || 'Sin descripción'}
                            </span>
                            <div class="registro-actions">
                                <button class="delete-registro-btn boton" data-id="${registro.id}">Eliminar</button>
                            </div>
                        `;
                        registrosList.appendChild(li);
                    });

                    // Añadir listeners para botones de eliminar
                    registrosList.querySelectorAll('.delete-registro-btn').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const registroId = e.target.dataset.id;
                            if (confirm('¿Estás seguro de que quieres eliminar este registro importante?')) {
                                try {
                                    const response = await fetch(`/api/registros_importantes/${registroId}`, {
                                        method: 'DELETE'
                                    });
                                    if (!response.ok) {
                                        const errorData = await response.json();
                                        throw new Error(errorData.error || 'Error al eliminar el registro.');
                                    }
                                    alert('Registro eliminado exitosamente!');
                                    loadRegistros(); // Recargar la lista
                                } catch (error) {
                                    console.error('Error al eliminar el registro:', error);
                                    alert(`No se pudo eliminar el registro. Error: ${error.message}`);
                                }
                            }
                        });
                    });

                } catch (error) {
                    console.error('Error al cargar los registros:', error);
                    registrosList.innerHTML = `<li class="error-message">Error al cargar registros: ${error.message}</li>`;
                }
            }

            // Cargar registros al cargar la página
            loadRegistros();
        });
    </script>
</body>
</html>