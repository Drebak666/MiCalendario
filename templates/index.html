<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Agenda</title>
    <!-- Favicon para el icono del acceso directo en móvil -->
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/agenda_icon.png') }}">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" xintegrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Estilos personalizados para los badges de conteo y algunas transiciones */
        .button-count, .button-nav-count {
            position: absolute;
            top: 0;
            right: 0;
            transform: translate(50%, -50%); /* Ajusta la posición del badge */
            background-color: #ef4444; /* Rojo de Tailwind */
            color: white;
            border-radius: 9999px; /* Para hacerlo circular */
            padding: 0.25rem 0.625rem; /* px-2 py-1 */
            font-size: 0.75rem; /* text-xs */
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 1.5rem; /* Para asegurar que sea circular */
            min-height: 1.5rem;
            line-height: 1; /* Eliminar espacio extra */
        }
        .boton {
            transition: all 0.2s ease-in-out;
        }
        .boton:hover {
            transform: translateY(-2px);
        }

        /* Estilos de la cámara */
        .camera-modal-content {
            max-width: 700px;
        }
        .camera-stream {
            width: 100%;
            max-width: 100%;
            height: auto;
            background-color: #000;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .photo-preview {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .camera-actions button {
            margin: 5px;
        }

        /* Estilos generales para ítems completados */
        .completed-item .entry-text,
        .completed-item .entry-time,
        .completed-item .time-left {
            text-decoration: line-through;
            color: #888;
            opacity: 0.7;
        }
        .completed-item .btn-completar {
            background-color: #28a745; /* Color verde para "Descompletar" */
            color: white;
        }
        .entry-item .btn-completar { /* Estilo para el botón de completar */
            background-color: #007bff;
            color: white;
        }
        /* Color para ítems con tiempo pasado (no completados) */
        .entry-item .time-left.pasada {
            color: #888; /* Gris para indicar que ha pasado la hora */
            font-style: italic;
        }
        .entry-item .time-left.vencida {
            color: #dc3545; /* Rojo para vencida */
        }

        /* Estilos específicos para Citas */
        .cita-item {
            background-color: #e0f7fa; /* Un azul claro para destacar */
            border-left: 5px solid #00acc1;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }
        .cita-item.completada {
            background-color: #f0f4c3; /* Un verde claro para citas completadas */
            border-left-color: #8bc34a;
        }
        .cita-item .entry-text {
            font-weight: bold;
            color: #333;
        }
        .cita-item .cita-info {
            font-size: 0.9em;
            color: #555;
            margin-top: 5px;
        }
        .cita-item .dias-restantes {
            font-weight: bold;
            color: #007bff;
            margin-left: 10px;
        }
        .cita-item.completada .dias-restantes {
             color: #888;
        }
        /* Los estilos quick-action-buttons se manejarán principalmente con Tailwind */
        /* .quick-action-buttons {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }
        .quick-action-buttons .boton {
            padding: 8px 12px;
            font-size: 0.9em;
        } */
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">
    <div class="max-w-4xl mx-auto p-4 bg-white shadow-lg rounded-lg mt-6">
        <div class="text-center text-xl font-semibold text-gray-700 mb-4" id="fechaActualDisplay"></div>

        <h2 class="text-2xl font-bold text-gray-800 mb-3 border-b pb-2">Citas Próximas:</h2> 
        <div class="list-section mb-6">
            <ul id="upcomingCitasList" class="space-y-2">
                <li class="text-gray-500 italic">Cargando citas...</li>
            </ul>
        </div>

        <h2 class="text-2xl font-bold text-gray-800 mb-3 border-b pb-2">Añadir Actividad:</h2> 
        <!-- Formulario Unificado para Tareas, Rutinas y Citas -->
        <form id="unifiedEntryForm" class="task-form-container p-4 bg-blue-50 rounded-lg shadow-inner">
            <div class="mb-4">
                <label for="entryType" class="block text-gray-700 text-sm font-bold mb-2">Tipo:</label>
                <select id="entryType" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <option value="tarea">Tarea</option>
                    <option value="rutina">Rutina</option>
                    <option value="cita">Cita</option>
                </select>
            </div>

            <div class="mb-4">
                <label for="entryTextInput" id="entryTextLabel" class="block text-gray-700 text-sm font-bold mb-2">Descripción:</label>
                <input type="text" id="entryTextInput" placeholder="Añadir una nueva tarea, rutina o cita..." required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>

            <div class="mb-4 flex items-center gap-4">
                <label for="entryTimeInput" id="entryTimeLabel" class="block text-gray-700 text-sm font-bold">Hora:</label>
                <input type="time" id="entryTimeInput" class="shadow appearance-none border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline w-1/3">
                
                <div class="flex-grow flex justify-end space-x-2">
                    <button type="button" class="relative bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full shadow-md hover:shadow-lg transition-all duration-200" id="quickListButton" title="Añadir a Lista de Compra">
                        <i class="fas fa-shopping-cart text-lg"></i>
                        <span class="button-count" id="quickListCount">0</span>
                    </button>
                    <button type="button" class="relative bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full shadow-md hover:shadow-lg transition-all duration-200" id="quickNotesButton" title="Añadir a Notas Rápidas">
                        <i class="fas fa-pencil-alt text-lg"></i>
                        <span class="button-count" id="quickNotesCount">0</span>
                    </button>
                    <button type="button" class="relative bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full shadow-md hover:shadow-lg transition-all duration-200" id="quickCitaButton" title="Añadir Cita">
                        <i class="fas fa-calendar-check text-lg"></i>
                        <span class="button-count" id="quickCitaCount">0</span>
                    </button>
                </div>
            </div>

            <!-- Campos de Rutina (inicialmente ocultos) -->
            <div id="routineFields" class="mb-4" style="display: none;">
                <div class="form-group day-selector">
                    <p class="block text-gray-700 text-sm font-bold mb-2">Repetir los días (solo para rutinas):</p>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                        <label class="flex items-center"><input type="checkbox" name="routineDay" value="Lunes" class="form-checkbox mr-2 rounded"> <span>Lunes</span></label>
                        <label class="flex items-center"><input type="checkbox" name="routineDay" value="Martes" class="form-checkbox mr-2 rounded"> <span>Martes</span></label>
                        <label class="flex items-center"><input type="checkbox" name="routineDay" value="Miércoles" class="form-checkbox mr-2 rounded"> <span>Miércoles</span></label>
                        <label class="flex items-center"><input type="checkbox" name="routineDay" value="Jueves" class="form-checkbox mr-2 rounded"> <span>Jueves</span></label>
                        <label class="flex items-center"><input type="checkbox" name="routineDay" value="Viernes" class="form-checkbox mr-2 rounded"> <span>Viernes</span></label>
                        <label class="flex items-center"><input type="checkbox" name="routineDay" value="Sábado" class="form-checkbox mr-2 rounded"> <span>Sábado</span></label>
                        <label class="flex items-center"><input type="checkbox" name="routineDay" value="Domingo" class="form-checkbox mr-2 rounded"> <span>Domingo</span></label>
                    </div>
                </div>
            </div>

            <!-- Campos de Cita (inicialmente ocultos, solo usados por el formulario principal) -->
            <div id="citaFields" class="mb-4" style="display: none;">
                <div class="form-group">
                    <label for="citaFechaInput" class="block text-gray-700 text-sm font-bold mb-2">Fecha de la Cita:</label>
                    <input type="date" id="citaFechaInput" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
            </div>

            <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:shadow-lg w-full transition-all duration-200">Guardar</button>
        </form>

        <h2 class="text-2xl font-bold text-gray-800 mt-8 mb-3 border-b pb-2">Agenda de Hoy:</h2>
        <div class="list-section mb-6">
            <ul id="combinedAgendaList" class="space-y-2">
                <li class="text-gray-500 italic">Cargando agenda...</li>
            </ul>
        </div>

        <h2 class="text-2xl font-bold text-gray-800 mt-8 mb-3 border-b pb-2">Navegación:</h2>
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-3 p-2">
            <a href="/calendario" class="boton flex flex-col items-center justify-center p-3 rounded-lg shadow hover:shadow-lg transition-shadow bg-blue-400 text-white">
                <i class="fas fa-calendar-alt text-2xl mb-1"></i>
                <span>Calendario</span>
            </a>
            <a href="/registros_importantes" class="boton flex flex-col items-center justify-center p-3 rounded-lg shadow hover:shadow-lg transition-shadow bg-purple-400 text-white">
                <i class="fas fa-file-alt text-2xl mb-1"></i>
                <span>Registros</span>
            </a>
            <a href="/alimentacion" class="boton flex flex-col items-center justify-center p-3 rounded-lg shadow hover:shadow-lg transition-shadow bg-yellow-400 text-white">
                <i class="fas fa-utensils text-2xl mb-1"></i>
                <span>Alimentación</span>
            </a>
            <a href="/documentacion" class="boton flex flex-col items-center justify-center p-3 rounded-lg shadow hover:shadow-lg transition-shadow bg-pink-400 text-white">
                <i class="fas fa-folder-open text-2xl mb-1"></i>
                <span>Documentos</span>
            </a>
            <a href="/gimnasio" class="boton flex flex-col items-center justify-center p-3 rounded-lg shadow hover:shadow-lg transition-shadow bg-red-400 text-white">
                <i class="fas fa-dumbbell text-2xl mb-1"></i>
                <span>Gimnasio</span>
            </a>
            <a href="/citas" class="relative boton flex flex-col items-center justify-center p-3 rounded-lg shadow hover:shadow-lg transition-shadow bg-teal-400 text-white">
                <i class="fas fa-calendar-check text-2xl mb-1"></i>
                <span>Citas</span>
                <span class="button-nav-count" id="navCitasCount">0</span>
            </a>
            <a href="/lista" class="relative boton flex flex-col items-center justify-center p-3 rounded-lg shadow hover:shadow-lg transition-shadow bg-orange-400 text-white">
                <i class="fas fa-shopping-cart text-2xl mb-1"></i>
                <span>Lista Compra</span>
                <span class="button-nav-count" id="navListCount">0</span>
            </a>
            <a href="/notas" class="relative boton flex flex-col items-center justify-center p-3 rounded-lg shadow hover:shadow-lg transition-shadow bg-indigo-400 text-white">
                <i class="fas fa-pencil-alt text-2xl mb-1"></i>
                <span>Notas</span>
                <span class="button-nav-count" id="navNotesCount">0</span>
            </a>
            <!-- Botón de Imagen Nube eliminado -->
        </div>
    </div>

    <!-- Modal para Captura de Foto -->
    <div id="cameraModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display:none;">
        <div class="bg-white p-6 rounded-lg shadow-xl camera-modal-content">
            <h3 class="text-xl font-bold mb-4 text-center">Tomar Foto</h3>
            <video id="videoStream" class="camera-stream" autoplay playsinline></video>
            <canvas id="photoCanvas" style="display:none;"></canvas>
            <img id="photoPreview" class="photo-preview" style="display:none;">
            <p id="cameraStatus" class="text-center text-sm text-gray-600 mb-4"></p>
            <div class="flex justify-center flex-wrap gap-2 camera-actions">
                <button id="capturePhotoButton" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full flex items-center space-x-2">
                    <i class="fas fa-camera"></i> <span>Tomar Foto</span>
                </button>
                <button id="retakePhotoButton" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full flex items-center space-x-2" style="display:none;">
                    <i class="fas fa-redo"></i> <span>Repetir</span>
                </button>
                <button id="confirmPhotoButton" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full flex items-center space-x-2" style="display:none;">
                    <i class="fas fa-check"></i> <span>Confirmar</span>
                </button>
                <button id="closeCameraModalButton" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full flex items-center space-x-2">
                    <i class="fas fa-times"></i> <span>Cerrar</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Alert/Confirm Modal HTML (GLOBAL) -->
    <div id="customModalOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display:none;">
        <div class="bg-white p-6 rounded-lg shadow-xl custom-modal-content">
            <h3 id="customModalTitle" class="text-xl font-bold mb-4 text-center"></h3>
            <p id="customModalMessage" class="mb-6 text-gray-700 text-center"></p>
            <div class="flex justify-center space-x-4" id="customModalActions">
                <!-- Buttons will be injected here -->
            </div>
        </div>
    </div>

    <!-- NUEVO: Modal para añadir cita rápida desde el botón de Cita -->
    <div id="quickCitaModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display:none;">
        <div class="bg-white p-6 rounded-lg shadow-xl custom-modal-content">
            <h3 class="text-xl font-bold mb-4 text-center">Registrar Cita Rápida</h3>
            <p id="quickCitaTextDisplay" class="mb-4 text-gray-700 text-center"></p>
            <div class="mb-4">
                <label for="quickCitaFechaInput" class="block text-gray-700 text-sm font-bold mb-2">Fecha de la Cita:</label>
                <input type="date" id="quickCitaFechaInput" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <div class="mb-6">
                <label for="quickCitaHoraInput" class="block text-gray-700 text-sm font-bold mb-2">Hora (opcional):</label>
                <input type="time" id="quickCitaHoraInput" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <div class="flex justify-center space-x-4">
                <button id="saveQuickCitaBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full">Guardar Cita</button>
                <button id="cancelQuickCitaBtn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        const fechaActualDisplay = document.getElementById('fechaActualDisplay');
        const combinedAgendaList = document.getElementById('combinedAgendaList');
        const upcomingCitasList = document.getElementById('upcomingCitasList'); 
        let fechaActual = new Date();
        let timeLeftUpdateInterval; 

        const unifiedEntryForm = document.getElementById('unifiedEntryForm');
        const entryTypeSelect = document.getElementById('entryType');
        const entryTextInput = document.getElementById('entryTextInput');
        const entryTextLabel = document.getElementById('entryTextLabel');
        const entryTimeInput = document.getElementById('entryTimeInput');
        const entryTimeLabel = document.getElementById('entryTimeLabel'); 
        const routineFieldsDiv = document.getElementById('routineFields');
        const routineDayCheckboxes = document.querySelectorAll('input[name="routineDay"]');
        const citaFieldsDiv = document.getElementById('citaFields'); 
        const citaFechaInput = document.getElementById('citaFechaInput'); 

        const quickListButton = document.getElementById('quickListButton');
        const quickNotesButton = document.getElementById('quickNotesButton');
        const quickCitaButton = document.getElementById('quickCitaButton'); 
        // const cloudImageButton = document.getElementById('cloudImageButton'); // ELIMINADO

        // Elements for count badges
        const quickListCountElem = document.getElementById('quickListCount');
        const quickNotesCountElem = document.getElementById('quickNotesCount');
        const quickCitaCountElem = document.getElementById('quickCitaCount');
        const navCitasCountElem = document.getElementById('navCitasCount');
        const navListCountElem = document.getElementById('navListCount');
        const navNotesCountElem = document.getElementById('navNotesCount');


        // Elementos de la Cámara
        const cameraModal = document.getElementById('cameraModal');
        const videoStream = document.getElementById('videoStream');
        const photoCanvas = document.getElementById('photoCanvas');
        const photoPreview = document.getElementById('photoPreview');
        const capturePhotoButton = document.getElementById('capturePhotoButton');
        const retakePhotoButton = document.getElementById('retakePhotoButton');
        const confirmPhotoButton = document.getElementById('confirmPhotoButton');
        const closeCameraModalButton = document.getElementById('closeCameraModalButton');
        const cameraStatus = document.getElementById('cameraStatus');

        let currentStream;
        let capturedImageBase64 = null;
        let currentRegistroPhotoPreviewElement = null;

        const dayNameToNumber = {
            'Domingo': 0, 'Lunes': 1, 'Martes': 2, 'Miércoles': 3, 'Jueves': 4, 'Viernes': 5, 'Sábado': 6
        };
        const dayNumberToName = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];

        let completedRoutineIdsForToday = new Set();

        // NUEVO: Elementos del modal de cita rápida
        const quickCitaModal = document.getElementById('quickCitaModal');
        const quickCitaTextDisplay = document.getElementById('quickCitaTextDisplay');
        const quickCitaFechaInput = document.getElementById('quickCitaFechaInput');
        const quickCitaHoraInput = document.getElementById('quickCitaHoraInput');
        const saveQuickCitaBtn = document.getElementById('saveQuickCitaBtn');
        const cancelQuickCitaBtn = document.getElementById('cancelQuickCitaBtn');


        function formatFecha(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function displayFechaActual() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            fechaActualDisplay.textContent = fechaActual.toLocaleDateString('es-ES', options);
        }

        async function fetchCombinedAgenda() {
            const todayDate = formatFecha(fechaActual);
            const todayDayOfWeek = (fechaActual.getDay()); 

            let allEntries = [];
            let upcomingCitas = []; 

            // Fetch Tasks
            try {
                const tasksResponse = await fetch(`/api/tareas/${todayDate}`);
                const tasks = await tasksResponse.json();
                tasks.forEach(task => {
                    allEntries.push({
                        ...task,
                        type: 'tarea',
                        displayTime: task.hora,
                        displayText: task.texto
                    });
                });
            } catch (error) {
                console.error('Error al cargar las tareas:', error);
            }

            // Fetch Routines
            try {
                const routinesResponse = await fetch('/api/rutinas');
                const routines = await routinesResponse.json();
                routines.forEach(routine => {
                    if (routine.dias && Array.isArray(routine.dias) && routine.dias.includes(todayDayOfWeek)) {
                        allEntries.push({
                            id: routine.id,
                            type: 'rutina',
                            displayTime: routine.hora,
                            displayText: routine.nombre,
                            dias: routine.dias
                        });
                    }
                });
            } catch (error) {
                console.error('Error al cargar las rutinas:', error);
            }

            // Fetch completed routines for today
            try {
                const completedRoutinesResponse = await fetch(`/api/rutinas/completadas_por_dia/${todayDate}`);
                if (!completedRoutinesResponse.ok) {
                    const errorText = await completedRoutinesResponse.text();
                    throw new Error(`Error al cargar rutinas completadas: ${errorText}`);
                }
                const completedRoutineIds = await completedRoutinesResponse.json();
                completedRoutineIdsForToday = new Set(completedRoutineIds);
            } catch (error) {
                console.error('Error fetching completed routines for today:', error);
                completedRoutineIdsForToday = new Set(); 
            }

            // Fetch Citas para el mes actual
            const currentMonth = fechaActual.getMonth() + 1; // 1-indexed
            const currentYear = fechaActual.getFullYear();
            try {
                const citasResponse = await fetch(`/api/citas/proximas/${currentYear}/${currentMonth}`);
                if (!citasResponse.ok) {
                    const errorText = await citasResponse.text();
                    throw new Error(`Error al cargar citas próximas: ${errorText}`);
                }
                upcomingCitas = await citasResponse.json();
                // FUTURO: Actualizar el contador de citas
                quickCitaCountElem.textContent = upcomingCitas.length;
                navCitasCountElem.textContent = upcomingCitas.length;
            } catch (error) {
                console.error('Error fetching upcoming citas:', error);
                upcomingCitas = [];
                quickCitaCountElem.textContent = '0'; // Default if error
                navCitasCountElem.textContent = '0';
            }

            // FUTURO: Fetch para el conteo de ítems de la lista de compra
            // try {
            //     const listCountResponse = await fetch('/api/lista_compra/count_uncompleted'); // Necesitas crear esta API en app.py
            //     if (listCountResponse.ok) {
            //         const count = await listCountResponse.json();
            //         quickListCountElem.textContent = count;
            //         navListCountElem.textContent = count;
            //     } else {
            //         console.warn('No se pudo obtener el conteo de la lista de compra.');
            //         quickListCountElem.textContent = '0';
            //         navListCountElem.textContent = '0';
            //     }
            // } catch (error) {
            //     console.error('Error fetching list count:', error);
            //     quickListCountElem.textContent = '0';
            //     navListCountElem.textContent = '0';
            // }

            // FUTURO: Fetch para el conteo de notas rápidas
            // try {
            //     const notesCountResponse = await fetch('/api/notas/count'); // Necesitas crear esta API en app.py
            //     if (notesCountResponse.ok) {
            //         const count = await notesCountResponse.json();
            //         quickNotesCountElem.textContent = count;
            //         navNotesCountElem.textContent = count;
            //     } else {
            //         console.warn('No se pudo obtener el conteo de notas.');
            //         quickNotesCountElem.textContent = '0';
            //         navNotesCountElem.textContent = '0';
            //     }
            // } catch (error) {
            //     console.error('Error fetching notes count:', error);
            //     quickNotesCountElem.textContent = '0';
            //     navNotesCountElem.textContent = '0';
            // }


            renderUpcomingCitas(upcomingCitas); // Renderizar citas en su propia sección
            renderCombinedAgenda(allEntries); // Renderizar tareas y rutinas
        }

        // Helper para obtener el objeto Date de un momento específico para la ordenación
        const getMoment = (dateStr, timeStr) => {
            if (!timeStr) return null; 
            const [h, m] = timeStr.split(':').map(Number);
            const [y, M, d] = dateStr.split('-').map(Number);
            return new Date(y, M - 1, d, h, m, 0); 
        };

        function renderUpcomingCitas(citas) {
            upcomingCitasList.innerHTML = '';
            if (citas.length === 0) {
                upcomingCitasList.innerHTML = '<li class="text-gray-500 italic">No hay citas pendientes para el mes actual.</li>';
                return;
            }

            citas.sort((a, b) => {
                const dateA = new Date(a.fecha + (a.hora ? `T${a.hora}` : 'T23:59'));
                const dateB = new Date(b.fecha + (b.hora ? `T${b.hora}` : 'T23:59'));
                return dateA - dateB;
            });

            citas.forEach(cita => {
                const li = document.createElement('li');
                li.classList.add('cita-item');
                if (cita.completada) { 
                    li.classList.add('completada');
                }

                const fechaFormateada = new Date(cita.fecha).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
                const horaFormateada = cita.hora ? cita.hora.substring(0, 5) : 'N/A';
                
                let diasRestantesText = '';
                if (cita.dias_restantes === 0) {
                    diasRestantesText = 'Hoy';
                } else if (cita.dias_restantes === 1) {
                    diasRestantesText = 'Mañana';
                } else if (cita.dias_restantes > 1) {
                    diasRestantesText = `En ${cita.dias_restantes} días`;
                } else {
                    diasRestantesText = 'Pasada'; 
                }

                li.innerHTML = `
                    <div class="flex-grow">
                        <span class="entry-text">${cita.nombre}</span>
                        <div class="cita-info">
                            Fecha: ${fechaFormateada} Hora: ${horaFormateada}
                        </div>
                    </div>
                    <div class="dias-restantes text-sm text-blue-600 font-semibold">${diasRestantesText}</div>
                `;
                upcomingCitasList.appendChild(li);
            });
        }


        function renderCombinedAgenda(entries) {
            combinedAgendaList.innerHTML = '';
            
            const todayDateString = formatFecha(fechaActual); 
            const now = new Date(); 

            entries.sort((a, b) => {
                const isACompleted = (a.type === 'tarea' && a.completada) || (a.type === 'rutina' && completedRoutineIdsForToday.has(a.id));
                const isBCompleted = (b.type === 'tarea' && b.completada) || (b.type === 'rutina' && completedRoutineIdsForToday.has(b.id));

                const aMoment = getMoment(todayDateString, a.displayTime);
                const bMoment = getMoment(todayDateString, b.displayTime);

                let priorityA, priorityB;

                if (isACompleted) {
                    priorityA = 3; 
                } else if (aMoment && aMoment < now) { 
                    priorityA = 2;
                } else { 
                    priorityA = 1;
                }

                if (isBCompleted) {
                    priorityB = 3;
                } else if (bMoment && bMoment < now) { 
                    priorityB = 2;
                } else { 
                    priorityB = 1;
                }

                if (priorityA !== priorityB) {
                    return priorityA - priorityB;
                }

                const timeA = a.displayTime || '24:00'; 
                const timeB = b.displayTime || '24:00'; 
                return timeA.localeCompare(timeB);
            });


            if (entries.length === 0) {
                combinedAgendaList.innerHTML = '<li class="text-gray-500 italic">No hay tareas ni rutinas programadas para hoy.</li>';
                if (timeLeftUpdateInterval) {
                    clearInterval(timeLeftUpdateInterval);
                    timeLeftUpdateInterval = null;
                }
                return;
            }

            entries.forEach(entry => {
                const li = document.createElement('li');
                li.dataset.id = entry.id;
                li.classList.add('entry-item', 'bg-white', 'p-3', 'rounded-lg', 'shadow-sm', 'flex', 'flex-col', 'md:flex-row', 'md:items-center', 'justify-between', 'space-y-2', 'md:space-y-0'); 

                const contentDiv = document.createElement('div');
                contentDiv.classList.add('flex-grow');

                const textSpan = document.createElement('span');
                textSpan.classList.add('entry-text', 'font-semibold', 'text-gray-800');

                const actionsDiv = document.createElement('div');
                actionsDiv.classList.add('entry-actions', 'flex', 'flex-wrap', 'gap-2', 'mt-2', 'md:mt-0', 'md:ml-4', 'justify-end');

                if (entry.type === 'tarea') {
                    li.classList.add('task-item');
                    li.dataset.fecha = entry.fecha;
                    li.dataset.textoOriginal = entry.displayText;
                    li.dataset.horaOriginal = entry.displayTime || ''; 

                    const formattedTime = entry.displayTime ? entry.displayTime.substring(0, 5) : '';
                    const horaPrefix = formattedTime ? `<span class="entry-time text-gray-500 text-sm">${formattedTime}</span> - ` : '';
                    textSpan.innerHTML = `${horaPrefix}${entry.displayText}`;
                    if (entry.completada) {
                        li.classList.add('completed-item'); 
                        textSpan.classList.add('completada'); 
                    }

                    const timeLeftSpan = document.createElement('span');
                    timeLeftSpan.classList.add('time-left', 'ml-2', 'text-sm');
                    timeLeftSpan.dataset.taskId = entry.id;
                    timeLeftSpan.dataset.taskDate = entry.fecha;
                    timeLeftSpan.dataset.taskTime = entry.displayTime || '';
                    contentDiv.appendChild(textSpan);
                    contentDiv.appendChild(timeLeftSpan);

                    const completeButton = document.createElement('button');
                    completeButton.classList.add('btn-completar', 'bg-blue-500', 'hover:bg-blue-700', 'text-white', 'py-1', 'px-3', 'rounded', 'text-sm', 'flex', 'items-center', 'space-x-1');
                    completeButton.dataset.id = entry.id;
                    completeButton.innerHTML = entry.completada ? '<i class="fas fa-undo"></i> <span>Descompletar</span>' : '<i class="fas fa-check"></i> <span>Completar</span>';
                    if (entry.completada) completeButton.classList.add('completada', 'bg-green-500', 'hover:bg-green-700'); // Estilo para descompletar
                    actionsDiv.appendChild(completeButton);
                    completeButton.addEventListener('click', toggleTaskCompletada);


                    const postponeButton = document.createElement('button');
                    postponeButton.classList.add('boton', 'bg-yellow-500', 'hover:bg-yellow-700', 'text-white', 'py-1', 'px-3', 'rounded', 'text-sm', 'flex', 'items-center', 'space-x-1');
                    postponeButton.innerHTML = '<i class="fas fa-calendar-alt"></i> <span>Aplazar</span>';
                    postponeButton.addEventListener('click', () => postponeTask(entry.id, entry.fecha, entry.hora, entry.displayText));
                    actionsDiv.appendChild(postponeButton);

                    const saveRegistroButton = document.createElement('button');
                    saveRegistroButton.classList.add('btn-guardar-registro-icon', 'bg-gray-500', 'hover:bg-gray-700', 'text-white', 'py-1', 'px-3', 'rounded', 'text-sm', 'flex', 'items-center', 'space-x-1');
                    saveRegistroButton.dataset.id = entry.id;
                    saveRegistroButton.title = 'Guardar en Registro';
                    saveRegistroButton.innerHTML = '<i class="fas fa-save"></i> <span>Registro</span>';
                    saveRegistroButton.addEventListener('click', () => saveTaskToRegistro(entry.id));
                    actionsDiv.appendChild(saveRegistroButton);

                    const deleteButton = document.createElement('button');
                    deleteButton.classList.add('btn-eliminar', 'bg-red-500', 'hover:bg-red-700', 'text-white', 'py-1', 'px-3', 'rounded', 'text-sm', 'flex', 'items-center', 'space-x-1');
                    deleteButton.dataset.id = entry.id;
                    deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i> <span>Eliminar</span>';
                    deleteButton.addEventListener('click', deleteTask);
                    actionsDiv.appendChild(deleteButton);


                } else if (entry.type === 'rutina') {
                    li.classList.add('routine-item');
                    const formattedTime = entry.displayTime ? entry.displayTime.substring(0, 5) : '';
                    const horaPrefix = formattedTime ? `<span class="entry-time text-gray-500 text-sm">${formattedTime}</span> - ` : '';
                    textSpan.innerHTML = `${horaPrefix}${entry.displayText}`;
                    contentDiv.appendChild(textSpan);

                    const timeLeftSpan = document.createElement('span');
                    timeLeftSpan.classList.add('time-left', 'ml-2', 'text-sm');
                    timeLeftSpan.dataset.taskId = `routine-${entry.id}`;
                    timeLeftSpan.dataset.taskDate = todayDateString; 
                    timeLeftSpan.dataset.taskTime = entry.displayTime || '';
                    contentDiv.appendChild(timeLeftSpan);

                    if (completedRoutineIdsForToday.has(entry.id)) {
                        li.classList.add('completed-item'); 
                        textSpan.classList.add('completada'); 
                    }

                    const completeRoutineButton = document.createElement('button');
                    completeRoutineButton.classList.add('btn-completar', 'bg-blue-500', 'hover:bg-blue-700', 'text-white', 'py-1', 'px-3', 'rounded', 'text-sm', 'flex', 'items-center', 'space-x-1');
                    completeRoutineButton.dataset.id = entry.id; 
                    
                    if (completedRoutineIdsForToday.has(entry.id)) {
                        completeRoutineButton.innerHTML = '<i class="fas fa-undo"></i> <span>Descompletar</span>';
                        completeRoutineButton.classList.add('completada', 'bg-green-500', 'hover:bg-green-700'); 
                    } else {
                        completeRoutineButton.innerHTML = '<i class="fas fa-check"></i> <span>Completar</span>';
                        completeRoutineButton.classList.remove('completada');
                    }

                    completeRoutineButton.addEventListener('click', async (event) => {
                        const routineId = entry.id;
                        try {
                            const response = await fetch(`/api/rutinas/${routineId}/toggle_completada_dia`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ fecha: todayDateString })
                            });

                            if (!response.ok) {
                                const errorData = await response.json();
                                throw new Error(errorData.error || 'Error al actualizar estado de rutina.');
                            }
                            showCustomAlert('Estado de rutina actualizado.', 'Actualización Exitosa');
                            fetchCombinedAgenda(); 
                        } catch (error) {
                            console.error('Error al cambiar estado de rutina:', error);
                            showCustomAlert(`No se pudo actualizar la rutina. Error: ${error.message}`, 'Error de Actualización');
                        }
                    });
                    actionsDiv.appendChild(completeRoutineButton);

                    const deleteButton = document.createElement('button');
                    deleteButton.classList.add('btn-eliminar', 'bg-red-500', 'hover:bg-red-700', 'text-white', 'py-1', 'px-3', 'rounded', 'text-sm', 'flex', 'items-center', 'space-x-1');
                    deleteButton.dataset.id = entry.id;
                    deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i> <span>Eliminar</span>';
                    deleteButton.addEventListener('click', deleteRoutine);
                    actionsDiv.appendChild(deleteButton);
                }

                li.appendChild(contentDiv);
                li.appendChild(actionsDiv);
                combinedAgendaList.appendChild(li);
            });

            if (timeLeftUpdateInterval) {
                clearInterval(timeLeftUpdateInterval);
            }
            timeLeftUpdateInterval = setInterval(updateAllTimeLeftCounters, 60 * 1000);
            updateAllTimeLeftCounters();
        }

        async function toggleTaskCompletada(event) {
            const taskId = event.target.dataset.id;
            try {
                const response = await fetch(`/api/tareas/${taskId}/toggle_completada`, {
                    method: 'PATCH',
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error desconocido al actualizar la tarea.');
                }
                fetchCombinedAgenda();
            } catch (error) {
                console.error('Error al cambiar estado:', error);
                const errorDetails = response && response.headers.get('content-type')?.includes('application/json')
                    ? (await response.json()).error
                    : (await response.text());
                showCustomAlert(`No se pudo actualizar la tarea. Error: ${errorDetails}`, 'Error de Actualización');
            }
        }

        async function deleteTask(event) {
            const taskId = event.target.dataset.id;
            const confirmAction = await showCustomConfirm('¿Estás seguro de que quieres eliminar esta tarea?');
            if (confirmAction) {
                try {
                    const response = await fetch(`/api/tareas/${taskId}`, {
                        method: 'DELETE'
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Error al eliminar la tarea');
                    }
                    showCustomAlert('Tarea eliminada exitosamente.', 'Eliminación Exitosa');
                    fetchCombinedAgenda();
                } catch (error) {
                    console.error('Error al eliminar la tarea:', error);
                    showCustomAlert(`No se pudo eliminar la tarea: ${error.message}`, 'Error de Eliminación');
                }
            }
        }

        function updateTimeLeft(itemId, itemDate, itemTime) {
            const targetElement = document.querySelector(`.time-left[data-task-id="${itemId}"]`);
            if (!targetElement) {
                return;
            }

            const parentItem = targetElement.closest('.task-item') || targetElement.closest('.routine-item');
            
            const todayDateString = formatFecha(fechaActual);
            const isRoutineItem = itemId.startsWith('routine-'); 

            if ((parentItem && parentItem.classList.contains('task-item') && parentItem.classList.contains('completed-item')) ||
                (isRoutineItem && completedRoutineIdsForToday.has(itemId.replace('routine-', '')))) { 
                targetElement.textContent = '';
                targetElement.classList.remove('vencida', 'pasada'); 
                return;
            }

            const now = new Date();
            let year, month, day, hours, minutes;

            const dateParts = itemDate.split('-');
            year = parseInt(dateParts[0]);
            month = parseInt(dateParts[1]) - 1;
            day = parseInt(dateParts[2]);

            let formattedItemTime = typeof itemTime === 'string' && itemTime.length >= 5 ? itemTime.substring(0, 5) : '';

            if (formattedItemTime.match(/^\d{2}:\d{2}$/)) {
                const timeParts = formattedItemTime.split(':');
                hours = parseInt(timeParts[0]);
                minutes = parseInt(timeParts[1]);
            } else {
                hours = 23;
                minutes = 59;
            }
            
            const itemMoment = new Date(year, month, day, hours, minutes, 0);

            if (isNaN(itemMoment.getTime())) { 
                targetElement.textContent = '(Fecha/Hora Inválida)';
                targetElement.style.color = '#dc3545';
                targetElement.classList.remove('pasada');
                if (parentItem) parentItem.querySelector('.entry-text').classList.add('vencida');
                return;
            }

            if (itemMoment < now) {
                if (isRoutineItem) { 
                    targetElement.textContent = '(Pasada)';
                    targetElement.style.color = '#888'; 
                    targetElement.classList.add('pasada'); 
                    if (parentItem) parentItem.querySelector('.entry-text').classList.remove('vencida'); 
                } else { 
                    targetElement.textContent = '(Vencida)';
                    targetElement.style.color = '#dc3545';
                    targetElement.classList.remove('pasada');
                    if (parentItem) parentItem.querySelector('.entry-text').classList.add('vencida');
                }
                return;
            }

            const diffMs = itemMoment - now;
            const days = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const hoursLeft = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutesLeft = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

            let timeLeftText = '';
            if (days > 0) {
                timeLeftText = `(${days} día${days !== 1 ? 's' : ''})`;
            } else if (hoursLeft > 0) {
                timeLeftText = `(${hoursLeft}h ${minutesLeft}m)`;
            } else if (minutesLeft > 0) {
                timeLeftText = `(${minutesLeft}m)`;
            } else {
                timeLeftText = '(Menos de 1m)';
            }

            targetElement.textContent = timeLeftText;
            targetElement.style.color = '#007bff';
            targetElement.classList.remove('pasada');
            if (parentItem) parentItem.querySelector('.entry-text').classList.remove('vencida');
        }

        function updateAllTimeLeftCounters() {
            const activeTasksTimeSpans = document.querySelectorAll('.task-item:not(.completed-item) .time-left, .routine-item:not(.completed-item) .time-left');
            activeTasksTimeSpans.forEach(span => {
                const itemId = span.dataset.taskId;
                const itemDate = span.dataset.taskDate;
                const itemTime = span.dataset.taskTime;
                updateTimeLeft(itemId, itemDate, itemTime);
            });
        }

        async function saveTaskToRegistro(taskId) {
            const taskElement = document.querySelector(`.task-item[data-id="${taskId}"]`);
            if (!taskElement) {
                console.error("Error: taskElement not found for taskId:", taskId);
                showCustomAlert('No se pudo encontrar la tarea para guardar. Intenta de nuevo.', 'Error');
                return;
            }

            const fecha = taskElement.dataset.fecha;
            const textoOriginal = taskElement.dataset.textoOriginal;
            
            let tiposDisponibles = [];
            try {
                const response = await fetch('/api/tipos_registro');
                if (!response.ok) throw new Error('Error al cargar los tipos de registro.');
                tiposDisponibles = await response.json();
            } catch (error) {
                console.error('Error al cargar tipos para el modal de registro:', error);
                showCustomAlert('No se pudieron cargar los tipos de registro. Se usará el tipo "General".', 'Advertencia');
                tiposDisponibles = [{ id: null, nombre: 'General' }];
            }

            tiposDisponibles.sort((a, b) => a.nombre.localeCompare(b.nombre));

            let tipoOptionsHtml = tiposDisponibles.map(type => 
                `<option value="${type.nombre}">${type.nombre}</option>`
            ).join('');

            const generalOptionExists = tiposDisponibles.some(type => type.nombre === 'General');
            if (!generalOptionExists) {
                tipoOptionsHtml = `<option value="General" selected>General</option>` + tipoOptionsHtml;
            } else {
                tipoOptionsHtml = tipoOptionsHtml.replace(`value="General"`, `value="General" selected`);
            }

            const formContent = document.createElement('div');
            formContent.innerHTML = `
                <h3 class="text-xl font-bold mb-4 text-center">Guardar en Registro Importante</h3>
                <div class="mb-4">
                    <label for="registroTitulo" class="block text-gray-700 text-sm font-bold mb-2">Título:</label>
                    <input type="text" id="registroTitulo" value="${textoOriginal}" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>

                <div class="mb-4">
                    <label for="registroDescripcion" class="block text-gray-700 text-sm font-bold mb-2">Descripción:</label>
                    <textarea id="registroDescripcion" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-24">${textoOriginal}</textarea>
                </div>

                <div class="mb-4">
                    <label for="registroTipo" class="block text-gray-700 text-sm font-bold mb-2">Tipo:</label>
                    <select id="registroTipo" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        ${tipoOptionsHtml}
                    </select>
                </div>
                
                <div class="mb-4 text-center">
                    <p class="text-gray-700 text-sm font-bold mb-2">Opcional: Adjuntar una foto</p>
                    <button type="button" id="openCameraButton" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full flex items-center justify-center mx-auto space-x-2">
                        <i class="fas fa-camera"></i> <span>Tomar Foto</span>
                    </button>
                    <img id="registroPhotoPreview" class="photo-preview mt-4 mx-auto" style="display:none;">
                </div>

                <div class="flex justify-center space-x-4">
                    <button id="guardarRegistroBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full">Guardar</button>
                    <button id="cancelRegistroBtn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full">Cancelar</button>
                </div>
            `;

            const modal = createModal(formContent);
            document.body.appendChild(modal);

            const openCameraButton = modal.querySelector('#openCameraButton');
            currentRegistroPhotoPreviewElement = modal.querySelector('#registroPhotoPreview');

            if (capturedImageBase64) { 
                currentRegistroPhotoPreviewElement.src = capturedImageBase64;
                currentRegistroPhotoPreviewElement.style.display = 'block';
            } else {
                currentRegistroPhotoPreviewElement.style.display = 'none';
            }

            openCameraButton.addEventListener('click', () => {
                console.log("DEBUG: Botón 'Tomar Foto' en modal de registro clickeado. Abriendo modal de cámara.");
                cameraModal.style.display = 'flex';
                videoStream.style.display = 'block';
                photoPreview.style.display = 'none';
                capturePhotoButton.style.display = 'block'; 
                retakePhotoButton.style.display = 'none';
                confirmPhotoButton.style.display = 'none';

                capturedImageBase64 = null;
                initCamera();
            });

            document.getElementById('guardarRegistroBtn').addEventListener('click', async () => {
                const titulo = document.getElementById('registroTitulo').value.trim();
                const descripcion = document.getElementById('registroDescripcion').value.trim();
                const tipo = document.getElementById('registroTipo').value;

                if (!titulo) {
                    showCustomAlert('El título es obligatorio.', 'Campo Obligatorio');
                    return;
                }

                try {
                    const response = await fetch('/api/registros_importantes/add_from_task', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ fecha, titulo, descripcion, tipo, imagen_base64: capturedImageBase64 })
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Error desconocido al guardar el registro.');
                    }
                    showCustomAlert('Registro guardado con éxito.', 'Guardado Exitoso');
                    modal.remove();
                    capturedImageBase64 = null;
                    currentRegistroPhotoPreviewElement = null;
                    console.log("DEBUG: Registro guardado, imagen Base64 y referencia limpiadas.");
                } catch (error) {
                    console.error('Error al guardar el registro:', error);
                    showCustomAlert(`No se pudo guardar el registro: ${error.message}`, 'Error de Guardado');
                }
            });

            document.getElementById('cancelRegistroBtn').addEventListener('click', () => {
                modal.remove();
                capturedImageBase64 = null;
                currentRegistroPhotoPreviewElement = null;
                stopCamera();
                console.log("DEBUG: Modal de registro cancelado, imagen y cámara detenidas.");
            });
        }

        function createModal(content) {
            const modalOverlay = document.createElement('div');
            modalOverlay.classList.add('fixed', 'inset-0', 'bg-black', 'bg-opacity-50', 'flex', 'items-center', 'justify-center', 'z-50');

            const modalContent = document.createElement('div');
            modalContent.classList.add('bg-white', 'p-6', 'rounded-lg', 'shadow-xl', 'max-w-md', 'mx-4', 'w-full');
            modalContent.appendChild(content);

            modalOverlay.appendChild(modalContent);

            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    modalOverlay.remove();
                    if (modalOverlay.id === 'cameraModal') {
                        stopCamera();
                        capturePhotoButton.style.display = 'block';
                        retakePhotoButton.style.display = 'none';
                        confirmPhotoButton.style.display = 'none';
                    }
                }
            });
            return modalOverlay;
        }

        function showCustomModal(message, title = 'Mensaje', type = 'alert') {
            return new Promise((resolve) => {
                const modalOverlay = document.getElementById('customModalOverlay');
                const modalTitle = document.getElementById('customModalTitle');
                const modalMessage = document.getElementById('customModalMessage');
                const modalActions = document.getElementById('customModalActions');

                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalActions.innerHTML = ''; 

                if (type === 'alert') {
                    const okButton = document.createElement('button');
                    okButton.classList.add('bg-blue-500', 'hover:bg-blue-700', 'text-white', 'font-bold', 'py-2', 'px-4', 'rounded-full');
                    okButton.textContent = 'Aceptar';
                    okButton.addEventListener('click', () => {
                        modalOverlay.style.display = 'none';
                        resolve(true);
                    });
                    modalActions.appendChild(okButton);
                } else if (type === 'confirm') {
                    const yesButton = document.createElement('button');
                    yesButton.classList.add('bg-green-500', 'hover:bg-green-700', 'text-white', 'font-bold', 'py-2', 'px-4', 'rounded-full');
                    yesButton.textContent = 'Sí';
                    yesButton.addEventListener('click', () => {
                        modalOverlay.style.display = 'none';
                        resolve(true);
                    });
                    const noButton = document.createElement('button');
                    noButton.classList.add('bg-gray-500', 'hover:bg-gray-700', 'text-white', 'font-bold', 'py-2', 'px-4', 'rounded-full');
                    noButton.textContent = 'No';
                    noButton.addEventListener('click', () => {
                        modalOverlay.style.display = 'none';
                        resolve(false);
                    });
                    modalActions.appendChild(yesButton);
                    modalActions.appendChild(noButton);
                }

                modalOverlay.style.display = 'flex';
            });
        }

        function showCustomAlert(message, title = 'Mensaje') {
            return showCustomModal(message, title, 'alert');
        }

        async function showCustomConfirm(message, title = 'Confirmación') {
            return await showCustomModal(message, title, 'confirm');
        }


        async function deleteRoutine(event) {
            const routineId = event.target.dataset.id;
            const confirmAction = await showCustomConfirm('¿Estás seguro de que quieres eliminar esta rutina?');
            if (confirmAction) {
                try {
                    const response = await fetch(`/api/rutinas/${routineId}`, {
                        method: 'DELETE'
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Error deleting routine');
                    }
                    showCustomAlert('Rutina eliminada con éxito.', 'Eliminación Exitosa');
                    fetchCombinedAgenda();
                }
                catch (error) {
                    console.error('Error deleting routine:', error);
                    showCustomAlert(`No se pudo eliminar la rutina: ${error.message}`, 'Error de Eliminación');
                }
            }
        }

        // --- Lógica del formulario unificado ---
        entryTypeSelect.addEventListener('change', () => {
            routineFieldsDiv.style.display = 'none';
            citaFieldsDiv.style.display = 'none'; 
            entryTimeInput.required = false;
            entryTimeLabel.textContent = 'Hora:'; 
            entryTextInput.placeholder = 'Añadir una nueva tarea, rutina o cita...';

            if (entryTypeSelect.value === 'rutina') {
                routineFieldsDiv.style.display = 'block';
                entryTextLabel.textContent = 'Nombre de la Rutina:';
                entryTextInput.placeholder = 'Ej. Meditar, Correr, Estudiar Inglés';
                entryTimeInput.required = true;
                entryTimeLabel.textContent = 'Hora (obligatoria):';
            } else if (entryTypeSelect.value === 'cita') {
                citaFieldsDiv.style.display = 'block';
                entryTextLabel.textContent = 'Nombre de la Cita:';
                entryTextInput.placeholder = 'Ej. Cita con el médico, Entrevista de trabajo';
                entryTimeInput.required = false; 
                entryTimeLabel.textContent = 'Hora (opcional):';
            } else { 
                entryTextLabel.textContent = 'Descripción:';
                entryTextInput.placeholder = 'Añadir una nueva tarea...';
            }
            routineDayCheckboxes.forEach(checkbox => checkbox.checked = false); 
            citaFechaInput.value = formatFecha(fechaActual); 
        });

        unifiedEntryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const type = entryTypeSelect.value;
            const text = entryTextInput.value.trim();
            const hora = entryTimeInput.value.trim();

            if (!text) {
                showCustomAlert('La descripción no puede estar vacía.', 'Campo Obligatorio');
                return;
            }

            if (type === 'tarea') {
                const fecha = formatFecha(fechaActual);
                try {
                    const response = await fetch('/api/tareas', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ fecha, texto: text, hora }),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Error desconocido al guardar la tarea.');
                    }
                    showCustomAlert('Tarea guardada con éxito.', 'Guardado Exitoso');
                    fetchCombinedAgenda();
                } catch (error) {
                    console.error('Error saving task:', error);
                    showCustomAlert(`No se pudo guardar la tarea. Inténtalo de nuevo. Error: ${error.message}`, 'Error de Guardado');
                }
            } else if (type === 'rutina') {
                const diasSeleccionados = Array.from(routineDayCheckboxes)
                                                .filter(checkbox => checkbox.checked)
                                                .map(checkbox => dayNameToNumber[checkbox.value]);

                if (!hora || diasSeleccionados.length === 0) {
                    showCustomAlert('Para una rutina, la hora y al menos un día son obligatorios.', 'Campos Obligatorios');
                    return;
                }

                try {
                    const response = await fetch('/api/rutinas', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ nombre: text, hora, dias: diasSeleccionados }),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Error desconocido al guardar la rutina.');
                    }
                    showCustomAlert('Rutina guardada con éxito.', 'Guardado Exitoso');
                    fetchCombinedAgenda();
                } catch (error) {
                    console.error('Error saving routine:', error);
                    showCustomAlert(`No se pudo guardar la rutina. Inténtalo de nuevo. Error: ${error.message}`, 'Error de Guardado');
                }
            } else if (type === 'cita') { 
                const citaFecha = citaFechaInput.value;

                if (!citaFecha) {
                    showCustomAlert('La fecha de la cita es obligatoria.', 'Campo Obligatorio');
                    return;
                }

                try {
                    const response = await fetch('/api/citas', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ nombre: text, fecha: citaFecha, hora: hora || null }),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Error desconocido al guardar la cita.');
                    }
                    showCustomAlert('Cita guardada con éxito.', 'Guardado Exitoso');
                    fetchCombinedAgenda(); 
                } catch (error) {
                    console.error('Error saving cita:', error);
                    showCustomAlert(`No se pudo guardar la cita. Inténtalo de nuevo. Error: ${error.message}`, 'Error de Guardado');
                }
            }

            entryTextInput.value = '';
            entryTimeInput.value = '';
            routineDayCheckboxes.forEach(checkbox => checkbox.checked = false);
            entryTypeSelect.value = 'tarea'; 
            entryTypeSelect.dispatchEvent(new Event('change')); 
        });

        // Event for the quick list button
        quickListButton.addEventListener('click', async () => {
            const rawInput = entryTextInput.value.trim();
            if (rawInput) {
                const itemsToAdd = rawInput.split(' ').filter(item => item.trim() !== '');

                let allItemsAddedSuccessfully = true;
                for (const item of itemsToAdd) {
                    try {
                        const response = await fetch('/api/lista_compra', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ item: item })
                        });
                        if (!response.ok) {
                            const errorData = await response.text();
                            throw new Error(errorData || `Error adding "${item}" to shopping list.`);
                        }
                        console.log(`Item "${item}" added successfully to shopping list.`);
                    } catch (error) {
                        console.error(`Error adding item "${item}" to shopping list:`, error);
                        showCustomAlert(`No se pudo añadir "${item}" a la lista de la compra: ${error.message}`, 'Error de Lista');
                        allItemsAddedSuccessfully = false;
                    }
                }
                entryTextInput.value = '';
            }
            window.location.href = '/lista';
        });

        // Event listener para el botón de Notas Rápidas
        quickNotesButton.addEventListener('click', async () => {
            const noteText = entryTextInput.value.trim();
            if (noteText) {
                const fecha = formatFecha(fechaActual); 
                try {
                    const response = await fetch('/api/notas', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ texto: noteText, fecha: fecha })
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Error desconocido al guardar la nota.');
                    }
                    showCustomAlert('Nota rápida guardada con éxito.', 'Nota Guardada');
                    entryTextInput.value = ''; 
                } catch (error) {
                    console.error('Error al guardar la nota rápida:', error);
                    showCustomAlert(`No se pudo guardar la nota rápida: ${error.message}`, 'Error al Guardar Nota');
                }
            }
            window.location.href = '/notas'; 
        });

        // NUEVO: Lógica para el botón de Citas Rápidas
        quickCitaButton.addEventListener('click', async () => {
            const citaText = entryTextInput.value.trim();
            
            if (!citaText) {
                window.location.href = '/citas'; // ENLACE CORREGIDO A RUTA FLASK
                return;
            }

            quickCitaTextDisplay.textContent = `Registrar cita: "${citaText}"`;
            quickCitaFechaInput.value = formatFecha(fechaActual); 
            quickCitaFechaInput.min = formatFecha(fechaActual); 
            quickCitaHoraInput.value = entryTimeInput.value.trim(); 
            quickCitaModal.style.display = 'flex';
        });

        saveQuickCitaBtn.addEventListener('click', async () => {
            const citaText = entryTextInput.value.trim(); 
            const citaFecha = quickCitaFechaInput.value;
            const citaHora = quickCitaHoraInput.value.trim();

            if (!citaFecha) {
                showCustomAlert('La fecha de la cita es obligatoria.', 'Campo Obligatorio');
                return;
            }

            try {
                const response = await fetch('/api/citas', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nombre: citaText, fecha: citaFecha, hora: citaHora || null })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error desconocido al guardar la cita rápida.');
                }
                showCustomAlert('Cita rápida guardada con éxito.', 'Cita Guardada');
                quickCitaModal.style.display = 'none'; 
                entryTextInput.value = ''; 
                entryTimeInput.value = ''; 
            } catch (error) {
                console.error('Error al guardar la cita rápida:', error);
                showCustomAlert(`No se pudo guardar la cita rápida: ${error.message}`, 'Error al Guardar Cita');
            }
            window.location.href = '/citas'; // ENLACE CORREGIDO A RUTA FLASK
        });

        cancelQuickCitaBtn.addEventListener('click', () => {
            quickCitaModal.style.display = 'none';
        });


        // Event listener para el botón de imagen de la nube (ejemplo)
        // cloudImageButton.addEventListener('click', () => { // ELIMINADO
        //     const imageUrl = 'https://placehold.co/800x600/FF5733/FFFFFF?text=Tu%20Imagen%20desde%20la%20Nube'; 
        //     window.open(imageUrl, '_blank');
        // });


        // --- Lógica de la Cámara ---
        async function initCamera() {
            cameraStatus.textContent = 'Iniciando cámara...';
            videoStream.style.display = 'block';
            photoPreview.style.display = 'none';
            capturePhotoButton.style.display = 'block'; 
            retakePhotoButton.style.display = 'none';
            confirmPhotoButton.style.display = 'none';
            console.log("DEBUG: Intentando iniciar cámara...");

            if (currentStream) {
                stopCamera();
            }

            try {
                currentStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: { exact: 'environment' }
                    }
                });
                videoStream.srcObject = currentStream;
                videoStream.play();
                cameraStatus.textContent = 'Cámara trasera activa. Haz clic en "Tomar Foto".';
                console.log("DEBUG: Cámara trasera iniciada con éxito.");
            } catch (err) {
                console.warn("ADVERTENCIA: No se pudo acceder a la cámara trasera, intentando la frontal:", err);
                cameraStatus.textContent = 'Cámara trasera no disponible, intentando la frontal.';
                try {
                    currentStream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'user'
                        }
                    });
                    videoStream.srcObject = currentStream;
                    videoStream.play();
                    cameraStatus.textContent = 'Cámara frontal activa. Haz clic en "Tomar Foto".';
                    console.log("DEBUG: Cámara frontal iniciada con éxito.");
                } catch (errFront) {
                    console.error("ERROR: No se pudo acceder a ninguna cámara: ", errFront);
                    showCustomAlert('No se pudo acceder a la cámara. Asegúrate de haber dado permiso y de que no esté en uso por otra aplicación.', 'Error de Cámara');
                    cameraModal.style.display = 'none';
                    cameraStatus.textContent = 'No se pudo acceder a ninguna cámara. Verifica permisos.';
                    return;
                }
            }
        }

        function stopCamera() {
            if (currentStream) {
                console.log("DEBUG: Deteniendo stream de cámara.");
                currentStream.getTracks().forEach(track => track.stop());
                videoStream.srcObject = null;
            }
        }

        capturePhotoButton.addEventListener('click', () => {
            console.log("DEBUG: Botón 'Tomar Foto' (de cámara) clickeado.");
            if (videoStream.readyState === videoStream.HAVE_ENOUGH_DATA) {
                console.log("DEBUG: Video stream tiene datos suficientes. Procediendo a capturar.");
                photoCanvas.width = videoStream.videoWidth;
                photoCanvas.height = videoStream.videoHeight;
                const context = photoCanvas.getContext('2d');
                context.drawImage(videoStream, 0, 0, photoCanvas.width, photoCanvas.height);
                
                capturedImageBase64 = photoCanvas.toDataURL('image/png');
                photoPreview.src = capturedImageBase64;

                videoStream.style.display = 'none';
                photoPreview.style.display = 'block';
                capturePhotoButton.style.display = 'none';
                retakePhotoButton.style.display = 'block';
                confirmPhotoButton.style.display = 'block';
                cameraStatus.textContent = 'Foto capturada. Confirma o repite.';
                stopCamera();
                console.log("DEBUG: Estado de botones y stream actualizados después de capturar.");
            } else {
                cameraStatus.textContent = 'Esperando stream de video para capturar...';
                console.log("DEBUG: Video stream aún no tiene datos suficientes (readyState: " + videoStream.readyState + ").");
            }
        });

        retakePhotoButton.addEventListener('click', () => {
            console.log("DEBUG: Botón 'Repetir' clickeado. Reiniciando cámara.");
            capturedImageBase64 = null;
            photoPreview.style.display = 'none';
            capturePhotoButton.style.display = 'block'; 
            retakePhotoButton.style.display = 'none';
            confirmPhotoButton.style.display = 'none';
            initCamera();
        });

        confirmPhotoButton.addEventListener('click', () => {
            console.log("DEBUG: Botón 'Confirmar' clickeado. Cerrando modal de cámara.");
            cameraModal.style.display = 'none';
            stopCamera();
            if (currentRegistroPhotoPreviewElement && capturedImageBase64) {
                currentRegistroPhotoPreviewElement.src = capturedImageBase64;
                currentRegistroPhotoPreviewElement.style.display = 'block';
            }
            cameraStatus.textContent = '';
            capturePhotoButton.style.display = 'block';
            retakePhotoButton.style.display = 'none';
            confirmPhotoButton.style.display = 'none';
        });

        closeCameraModalButton.addEventListener('click', () => {
            console.log("DEBUG: Botón 'Cerrar' modal de cámara clickeado.");
            cameraModal.style.display = 'none';
            stopCamera();
            capturedImageBase64 = null;
            if (currentRegistroPhotoPreviewElement) {
                currentRegistroPhotoPreviewElement.src = '';
                currentRegistroPhotoPreviewElement.style.display = 'none';
            }
            currentRegistroPhotoPreviewElement = null;
            cameraStatus.textContent = '';
            capturePhotoButton.style.display = 'block';
            retakePhotoButton.style.display = 'none';
            confirmPhotoButton.style.display = 'none';
        });

        // --- Funciones de Acción (Aplazar - COPIADAS DE calendario.html) ---
        async function postponeTask(taskId, currentFecha, currentHora, currentTexto) {
            const confirmAction = await showCustomConfirm('¿Estás seguro de que quieres aplazar la tarea "${currentTexto}"?');
            if (!confirmAction) {
                return;
            }

            const formContent = document.createElement('div');
            formContent.innerHTML = `
                <h3 class="text-xl font-bold mb-4 text-center">Aplazar Tarea</h3>
                <p class="mb-4 text-gray-700 text-center">Tarea: <strong class="font-semibold">${currentTexto}</strong></p>
                <div class="mb-4">
                    <label for="newFecha" class="block text-gray-700 text-sm font-bold mb-2">Nueva Fecha:</label>
                    <input type="date" id="newFecha" value="${currentFecha}" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="mb-6">
                    <label for="newHora" class="block text-gray-700 text-sm font-bold mb-2">Nueva Hora (opcional):</label>
                    <input type="time" id="newHora" value="${currentHora ? currentHora.substring(0, 5) : ''}" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="flex justify-center space-x-4">
                    <button id="aplazarBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full">Aplazar</button>
                    <button id="cancelAplazarBtn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full">Cancelar</button>
                </div>
            `;

            const modal = createModal(formContent);
            document.body.appendChild(modal);

            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            document.getElementById('newFecha').min = `${year}-${month}-${day}`;


            document.getElementById('aplazarBtn').addEventListener('click', async () => {
                const newFecha = document.getElementById('newFecha').value;
                const newHora = document.getElementById('newHora').value;

                if (!newFecha) {
                    showCustomAlert('Por favor, selecciona una nueva fecha.', 'Campo Obligatorio');
                    return;
                }

                try {
                    const response = await fetch(`/api/tareas/${taskId}/aplazar`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ new_fecha: newFecha, new_hora: newHora || null })
                    });

                    if (!response.ok) {
                        let errorMessage = 'Error desconocido al aplazar la tarea.';
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const errorData = await response.json();
                            errorMessage = errorData.error || errorMessage;
                        } else {
                            const errorText = await response.text();
                            errorMessage = `El servidor respondió con un error no JSON. Código: ${response.status}. Mensaje: ${errorText.substring(0, 100)}...`;
                            console.error("Respuesta de error no JSON del servidor:", errorText);
                        }
                        throw new Error(errorMessage);
                    }
                    showCustomAlert('Tarea aplazada con éxito.', 'Aplazamiento Exitoso');
                    modal.remove();
                    fetchCombinedAgenda();
                } catch (error) {
                    console.error('Error al aplazar la tarea:', error);
                    showCustomAlert(`No se pudo aplazar la tarea. Error: ${error.message}`, 'Error al Aplazar');
                }
            });

            document.getElementById('cancelAplazarBtn').addEventListener('click', () => {
                modal.remove();
            });
        }


        document.addEventListener('DOMContentLoaded', () => {
            displayFechaActual();
            // Asegurarse de que el input de fecha de cita siempre tenga la fecha actual como mínimo
            const today = new Date();
            const todayFormatted = formatFecha(today);
            citaFechaInput.min = todayFormatted;
            citaFechaInput.value = todayFormatted; // Establecer valor inicial a hoy

            fetchCombinedAgenda();
            entryTypeSelect.dispatchEvent(new Event('change')); // Initial dispatch to set form fields
        });
    </script>
</body>
</html>
